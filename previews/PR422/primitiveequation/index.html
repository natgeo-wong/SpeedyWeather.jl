<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Primitive equation model · SpeedyWeather.jl</title><meta name="title" content="Primitive equation model · SpeedyWeather.jl"/><meta property="og:title" content="Primitive equation model · SpeedyWeather.jl"/><meta property="twitter:title" content="Primitive equation model · SpeedyWeather.jl"/><meta name="description" content="Documentation for SpeedyWeather.jl."/><meta property="og:description" content="Documentation for SpeedyWeather.jl."/><meta property="twitter:description" content="Documentation for SpeedyWeather.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SpeedyWeather.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><a class="tocitem" href="../how_to_run_speedy/">How to run SpeedyWeather.jl</a></li><li><a class="tocitem" href="../setups/">Model setups</a></li><li><a class="tocitem" href="../spectral_transform/">Spherical Harmonic Transform</a></li><li><a class="tocitem" href="../grids/">Grids</a></li><li><a class="tocitem" href="../barotropic/">Barotropic model</a></li><li><a class="tocitem" href="../shallowwater/">Shallow water model</a></li><li class="is-active"><a class="tocitem" href>Primitive equation model</a><ul class="internal"><li><a class="tocitem" href="#Virtual-temperature"><span>Virtual temperature</span></a></li><li><a class="tocitem" href="#Vertical-coordinates"><span>Vertical coordinates</span></a></li><li><a class="tocitem" href="#Geopotential"><span>Geopotential</span></a></li><li><a class="tocitem" href="#Surface-pressure-tendency"><span>Surface pressure tendency</span></a></li><li><a class="tocitem" href="#Vertical-advection"><span>Vertical advection</span></a></li><li><a class="tocitem" href="#Pressure-gradient"><span>Pressure gradient</span></a></li><li><a class="tocitem" href="#Vorticity-advection"><span>Vorticity advection</span></a></li><li><a class="tocitem" href="#Humidity-equation"><span>Humidity equation</span></a></li><li><a class="tocitem" href="#Temperature-equation"><span>Temperature equation</span></a></li><li><a class="tocitem" href="#implicit_primitive"><span>Semi-implicit time stepping</span></a></li><li><a class="tocitem" href="#Horizontal-diffusion"><span>Horizontal diffusion</span></a></li><li><a class="tocitem" href="#Algorithm"><span>Algorithm</span></a></li><li><a class="tocitem" href="#Scaled-primitive-equations"><span>Scaled primitive equations</span></a></li><li><a class="tocitem" href="#References"><span>References</span></a></li></ul></li><li><a class="tocitem" href="../parameterizations/">Parameterizations</a></li><li><a class="tocitem" href="../extending/">Extending SpeedyWeather</a></li><li><a class="tocitem" href="../output/">NetCDF output</a></li><li><a class="tocitem" href="../ringgrids/">Submodule: RingGrids</a></li><li><a class="tocitem" href="../lowertriangularmatrices/">Submodule: LowerTriangularMatrices</a></li><li><a class="tocitem" href="../speedytransforms/">Submodule: SpeedyTransforms</a></li><li><a class="tocitem" href="../functions/">Function and type index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Primitive equation model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Primitive equation model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl/blob/main/docs/src/primitiveequation.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Primitive-equation-model"><a class="docs-heading-anchor" href="#Primitive-equation-model">Primitive equation model</a><a id="Primitive-equation-model-1"></a><a class="docs-heading-anchor-permalink" href="#Primitive-equation-model" title="Permalink"></a></h1><p>The <a href="https://en.wikipedia.org/wiki/Primitive_equations">primitive equations</a> are a hydrostatic approximation of the compressible Navier-Stokes equations for an ideal gas on a rotating sphere. We largely follow the idealised spectral dynamical core developed by GFDL<sup class="footnote-reference"><a id="citeref-GFDL1" href="#footnote-GFDL1">[GFDL1]</a></sup> and documented therein<sup class="footnote-reference"><a id="citeref-GFDL2" href="#footnote-GFDL2">[GFDL2]</a></sup>.</p><p>The primitive equations solved by SpeedyWeather.jl for relative vorticity <span>$\zeta$</span>, divergence <span>$\mathcal{D}$</span>, logarithm of surface pressure <span>$\ln p_s$</span>, temperature <span>$T$</span> and specific humidity <span>$q$</span> are</p><p class="math-container">\[\begin{aligned}
\frac{\partial \zeta}{\partial t} &amp;= \nabla \times (\mathbf{\mathcal{P}}_\mathbf{u}
+ (f+\zeta)\mathbf{u}_\perp - W(\mathbf{u}) - R_dT_v\nabla \ln p_s) \\
\frac{\partial \mathcal{D}}{\partial t} &amp;= \nabla \cdot (\mathcal{P}_\mathbf{u}
+ (f+\zeta)\mathbf{u}_\perp - W(\mathbf{u}) - R_dT_v\nabla \ln p_s) - \nabla^2(\frac{1}{2}(u^2 + v^2) + \Phi) \\
\frac{\partial \ln p_s}{\partial t} &amp;= -\frac{1}{p_s} \nabla \cdot \int_0^{p_s} \mathbf{u}~dp \\
\frac{\partial T}{\partial t} &amp;= \mathcal{P}_T -\nabla\cdot(\mathbf{u}T) + T\mathcal{D} - W(T) + \kappa T_v \frac{D \ln p}{Dt} \\
\frac{\partial q}{\partial t} &amp;= \mathcal{P}_q -\nabla\cdot(\mathbf{u}q) + q\mathcal{D} - W(q)\\
\end{aligned}\]</p><p>with velocity <span>$\mathbf{u} = (u,v)$</span>, rotated velocity <span>$\mathbf{u}_\perp = (v,-u)$</span>, Coriolis parameter <span>$f$</span>, <span>$W$</span> the <a href="#Vertical-advection">Vertical advection</a> operator, dry air gas constant <span>$R_d$</span>, <a href="#Virtual-temperature">Virtual temperature</a> <span>$T_v$</span>, <a href="#Geopotential">Geopotential</a> <span>$\Phi$</span>, pressure <span>$p$</span> and surface pressure <span>$p_s$</span>, thermodynamic <span>$\kappa = R\_d/c_p$</span> with <span>$c_p$</span> the heat capacity at constant pressure. Horizontal hyper diffusion of the form <span>$(-1)^{n+1}\nu\nabla^{2n}$</span> with coefficient <span>$\nu$</span> and power <span>$n$</span>  is added for every variable that is advected, meaning <span>$\zeta, \mathcal{D}, T, q$</span>, but left out here for clarity, see <a href="../barotropic/#diffusion">Horizontal diffusion</a>.</p><p>The parameterizations for the tendencies of <span>$u,v,T,q$</span> from physical processes are denoted as <span>$\mathcal{P}_\mathbf{u} = (\mathcal{P}_u, \mathcal{P}_v), \mathcal{P}_T, \mathcal{P}_q$</span> and are further described in the corresponding sections, see <a href="../parameterizations/#parameterizations">Parameterizations</a>.</p><p>SpeedyWeather.jl implements a <code>PrimitiveWet</code> and a <code>PrimitiveDry</code> dynamical core. For a dry atmosphere, we have <span>$q = 0$</span> and the virtual temperature <span>$T_v = T$</span> equals the temperature (often called <em>absolute</em> to distinguish from the virtual temperature). The terms in the primitive equations and their discretizations are discussed in the following sections. </p><h2 id="Virtual-temperature"><a class="docs-heading-anchor" href="#Virtual-temperature">Virtual temperature</a><a id="Virtual-temperature-1"></a><a class="docs-heading-anchor-permalink" href="#Virtual-temperature" title="Permalink"></a></h2><div class="admonition is-info"><header class="admonition-header">In short: Virtual temperature</header><div class="admonition-body"><p>Virtual temperature is the temperature dry air would need to have to be as light as moist air. It is used in the dynamical core to include the effect of humidity on the density while replacing density through the ideal gas law with temperature.</p></div></div><p>We assume the atmosphere to be composed of two ideal gases: Dry air and water vapour. Given a specific humidity <span>$q$</span> both gases mix, their pressures <span>$p_d$</span>, <span>$p_w$</span> (<span>$d$</span> for dry, <span>$w$</span> for water vapour), and densities <span>$\rho_d, \rho_w$</span> add in a given air parcel that has temperature <span>$T$</span>. The ideal gas law then holds for both gases</p><p class="math-container">\[\begin{aligned}
p_d &amp;= \rho_d R_d T \\
p_w &amp;= \rho_w R_w T \\
\end{aligned}\]</p><p>with the respective specific gas constants <span>$R_d = R/m_d$</span> and <span>$R_w = R/m_w$</span> obtained from the universal gas constant <span>$R$</span> divided by the molecular masses of the gas. The total pressure <span>$p$</span> in the air parcel is</p><p class="math-container">\[p = p_d + p_w = (\rho_d R_d + \rho_w R_w)T\]</p><p>We ultimately want to replace the density <span>$\rho = \rho_w + \rho_d$</span> in the dynamical core, using the ideal gas law, with the temperature <span>$T$</span>, so that we never have to calculate the density explicitly. However, in order to not deal with two densities (dry air and water vapour) we would like to replace temperature with a virtual temperature that includes the effect of humidity on the density. So, wherever we use the ideal gas law to replace density with temperature, we would use the virtual temperature, which is a function of the absolute temperature and specific humidity, instead. A higher specific humidity in an air parcel lowers  the density as water vapour is lighter than dry air. Consequently, the virtual temperature of moist air is higher than its absolute temperature because warmer air is lighter too at constant pressure. We therefore think of the virtual temperature as the temperature dry air would need to have to be as light as moist air.</p><p>Starting with the last equation, with some manipulation we can write the ideal gas law as total density <span>$\rho$</span> times a gas constant times the virtual temperature that is supposed to be a function of absolute temperature, humidity and some constants</p><p class="math-container">\[p  = (\rho R_d + \rho_w (R_w - R_d)) T = \rho R_d (1 +
\frac{1 - \tfrac{R_d}{R_w}}{\tfrac{R_d}{R_w}} \frac{\rho_w}{\rho_w + \rho_d})T\]</p><p>Now we identify</p><p class="math-container">\[\mu = \frac{1 - \tfrac{R_d}{R_w}}{\tfrac{R_d}{R_w}}\]</p><p>as some constant that is positive for water vapour being lighter than dry air (<span>$\tfrac{R_d}{R_w} = \tfrac{m_w}{m_d} &lt; 1$</span>) and</p><p class="math-container">\[q = \frac{\rho_w}{\rho_w + \rho_d}\]</p><p>as the specific humidity. Given temperature <span>$T$</span> and specific humidity <span>$q$</span>, we can therefore calculate the virtual temperature <span>$T_v$</span> as</p><p class="math-container">\[T_v = (1 + \mu q)T\]</p><p>For completeness we want to mention here that the above product, because it is a  product of two variables <span>$q,T$</span> has to be computed in grid-point space, see <a href="../spectral_transform/#Spherical-Harmonic-Transform">Spherical Harmonic Transform</a>. To obtain an approximation to the virtual temperature in spectral space without expensive transforms one can linearize</p><p class="math-container">\[T_v \approx T + \mu q\bar{T}\]</p><p>with a global constant temperature <span>$\bar{T}$</span>, for example obtained from the <span>$l=m=0$</span> mode, <span>$\bar{T} = T_{0,0}\frac{1}{\sqrt{4\pi}}$</span> but depending on the normalization of the spherical harmonics that factor needs adjustment. We call this the <em>linear virtual temperature</em> which is used for the geopotential calculation, see <a href="https://github.com/SpeedyWeather/SpeedyWeather.jl/issues/254">#254</a>.</p><h2 id="Vertical-coordinates"><a class="docs-heading-anchor" href="#Vertical-coordinates">Vertical coordinates</a><a id="Vertical-coordinates-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-coordinates" title="Permalink"></a></h2><p>We start with some general considerations that apply when changing the vertical coordinate from height <span>$z$</span> to something else. Let <span>$\Psi(x,y,z,t)$</span> be some variable that depends on space and time. Now we want to express <span>$\Psi$</span> using some other coordinate <span>$\eta$</span> in the vertical. Regardless of the coordinate system the value of <span>$\Psi$</span> at the to <span>$z$</span> corresponding <span>$\eta$</span> (and vice versa) has to be the same as we only want to change the coordinate, not <span>$\Psi$</span> itself.</p><p class="math-container">\[\Psi(x,y,\eta,t) = \Psi(x,y,z(x,y,\eta,t),t)\]</p><p>So you can think of <span>$z$</span> as a function of <span>$\eta$</span> and <span>$\eta$</span> as a function of <span>$z$</span>. The chain rule lets us differentiate <span>$\Psi$</span> with respect to <span>$z$</span> or <span>$\eta$</span></p><p class="math-container">\[\frac{\partial \Psi}{\partial z} = \frac{\partial \Psi}{\partial \eta}\frac{\partial \eta}{\partial z},
\qquad \frac{\partial \Psi}{\partial \eta} = \frac{\partial \Psi}{\partial z}\frac{\partial z}{\partial \eta}\]</p><p>But for derivatives with respect to <span>$x,y,t$</span> we have to apply the multi-variable chain-rule as both <span>$\Psi$</span> and <span>$\eta$</span> depend on it. So a derivative with respect to <span>$x$</span> on <span>$\eta$</span> levels (where <span>$\eta$</span> constant) becomes</p><p class="math-container">\[\left. \frac{\partial \Psi}{\partial x}\right\vert_\eta = 
\left. \frac{\partial \Psi}{\partial x}\right\vert_z +
\frac{\partial \Psi}{\partial z}
\left. \frac{\partial z}{\partial x}\right\vert_\eta\]</p><p>So we first take the derivative of <span>$\Psi$</span> with respect to <span>$x$</span>, but then also have to account for the fact that, at a given <span>$\eta$</span>, <span>$z$</span> depends on <span>$x$</span> which is again dealt with using the univariate chain rule from above. We will make use of that for the <a href="#Pressure-gradient">Pressure gradient</a>.</p><h3 id="Sigma-coordinates"><a class="docs-heading-anchor" href="#Sigma-coordinates">Sigma coordinates</a><a id="Sigma-coordinates-1"></a><a class="docs-heading-anchor-permalink" href="#Sigma-coordinates" title="Permalink"></a></h3><p>The problem with pure pressure coordinates is that they are not terrain-following. For example, the 1000 hPa level in the Earth&#39;s atmosphere cuts through mountains. A flow field on such a level is therefore not continuous and one would need to deal with boundaries. Especially with spherical harmonics we need a terrain-following vertical coordinate to transform between continuous fields in grid-point space and spectral space.</p><p>SpeedyWeather.jl currently uses so-called sigma coordinates for the vertical.  This coordinate system uses fraction of surface pressure in the vertical, i.e.</p><p class="math-container">\[\sigma = \frac{p}{p_s}\]</p><p>with <span>$\sigma = [0,1]$</span> and <span>$\sigma = 0$</span> being the top (zero pressure) and <span>$\sigma = 1$</span> the surface (at surface pressure). As a consequence the vertical dimension is also indexed from top to surface.</p><div class="admonition is-info"><header class="admonition-header">Vertical indexing</header><div class="admonition-body"><p>Pressure, sigma, or hybrid coordinates in the vertical range from lowest values at the top to highest values at the surface. Consistently, we also index the vertical dimension top to surface. This means that <span>$k=1$</span> is the top-most layer, and <span>$k=N_{lev}$</span> (or similar) is the layer that sits directly above the surface.</p></div></div><p>Sigma coordinates are therefore terrain-following, as <span>$\sigma = 1$</span> is always at surface pressure and so this level bends itself around every mountain, although the actual pressure on this level can vary. For a visualisation see <a href="https://github.com/SpeedyWeather/SpeedyWeather.jl/issues/329">#329</a>.</p><p>One chooses <span>$\sigma$</span> levels associated with the <span>$k$</span>-th layer and the pressure can be reobtained from the surface pressure <span>$p_s$</span></p><p class="math-container">\[p_k = \sigma_kp_s\]</p><p>The layer thickness in terms of pressure is</p><p class="math-container">\[\Delta p_k = p_{k+\tfrac{1}{2}} - p_{k-\tfrac{1}{2}} =
(\sigma_{k+\tfrac{1}{2}} - \sigma_{k-\tfrac{1}{2}}) p_s = \Delta \sigma_k p_s\]</p><p>which can also be expressed with the layer thickness in sigma coordinates <span>$\Delta \sigma_k$</span> times the surface pressure. In SpeedyWeather.jl one chooses the half levels <span>$\sigma_{k+\tfrac{1}{2}}$</span> first and then obtains the full levels through averaging</p><p class="math-container">\[\sigma_k = \frac{\sigma_{k+\tfrac{1}{2}} + \sigma_{k-\tfrac{1}{2}}}{2}\]</p><h2 id="Geopotential"><a class="docs-heading-anchor" href="#Geopotential">Geopotential</a><a id="Geopotential-1"></a><a class="docs-heading-anchor-permalink" href="#Geopotential" title="Permalink"></a></h2><p>In the hydrostatic approximation the vertical momentum equation becomes</p><p class="math-container">\[\frac{\partial p}{\partial z} = -\rho g,\]</p><p>meaning that the (negative) vertical pressure gradient is given by the density in  that layer times the gravitational acceleration. The heavier the fluid the more the pressure will increase below. Inserting the ideal gas law</p><p class="math-container">\[\frac{\partial gz}{\partial p} = -\frac{R_dT_v}{p},\]</p><p>with the geopotential <span>$\Phi = gz$</span> we can write this in terms of the logarithm of pressure</p><p class="math-container">\[\frac{\partial \Phi}{\partial \ln p} = -R_dT_v.\]</p><p>Note that we use the <a href="#Virtual-temperature">Virtual temperature</a> here as we replaced the density through the ideal gas law with temperature. Given a vertical temperature profile <span>$T_v$</span> and the (constant) surface geopotential <span>$\Phi_s = gz_s$</span> where <span>$z_s$</span> is the orography, we can integrate this equation from the surface to the top to obtain <span>$\Phi_k$</span> on every layer <span>$k$</span>. The surface is at <span>$k = N+\tfrac{1}{2}$</span> (see <a href="#Vertical-coordinates">Vertical coordinates</a>)  with <span>$N$</span> vertical levels. We can integrate the geopotential onto half levels as (<span>$T_k^v$</span> is the virtual temperature at layer <span>$k$</span>, the subscript <span>$v$</span> has been moved to be a superscript)</p><p class="math-container">\[\Phi_{k-\tfrac{1}{2}} = \Phi_{k+\tfrac{1}{2}} + R_dT^v_k(\ln p_{k+1/2} - \ln p_{k-1/2})\]</p><p>or onto full levels with</p><p class="math-container">\[\Phi_{k} = \Phi_{k+\tfrac{1}{2}} + R_dT^v_k(\ln p_{k+1/2} - \ln p_k).\]</p><p>We use this last formula first to get from <span>$\Phi_s$</span> to <span>$\Phi_N$</span>, and then for every <span>$k$</span> twice to get from <span>$\Phi_k$</span> to <span>$\Phi_{k-1}$</span> via <span>$\Phi_{k-\tfrac{1}{2}}$</span>. For the first half-level integration we use <span>$T_k$</span> for the second <span>$T_{k-1}$</span>.</p><div class="admonition is-warning"><header class="admonition-header">Semi-implicit time integration: Geopotential</header><div class="admonition-body"><p>With the semi-implicit time integration in SpeedyWeather the Geopotential is not calculated from the spectral temperature  at the current, but at the previous time step. This is because this is a linear term that we solve implicitly to avoid instabilities from gravity waves. For details see section <a href="#implicit_primitive">Semi-implicit time stepping</a>.</p></div></div><h2 id="Surface-pressure-tendency"><a class="docs-heading-anchor" href="#Surface-pressure-tendency">Surface pressure tendency</a><a id="Surface-pressure-tendency-1"></a><a class="docs-heading-anchor-permalink" href="#Surface-pressure-tendency" title="Permalink"></a></h2><p>The surface pressure increases with a convergence of the flow above. Written in terms of the surface pressure directly, and not its logarithm</p><p class="math-container">\[\frac{\partial p_s}{\partial t} = -\nabla \cdot \int_0^{p_s} \mathbf{u}~dp\]</p><p>For <span>$k$</span> discrete layers from 1 at the top to <span>$N$</span> at the surface layer this can be written as</p><p class="math-container">\[\frac{\partial p_s}{\partial t} = - \sum_{k=1}^N \nabla \cdot (\mathbf{u}_k \Delta p_k)\]</p><p>which can be thought of as a vertical integration of the pressure thickness-weighted divergence. In <span>$\sigma$</span>-coordinates with <span>$\Delta p_k = \Delta \sigma_k p_s$</span> (see <a href="#Vertical-coordinates">Vertical coordinates</a>) this becomes</p><p class="math-container">\[\frac{\partial p_s}{\partial t} = - \sum_{k=1}^N \sigma_k \nabla \cdot (\mathbf{u}_k p_s)
= -\sum_{k=1}^N \sigma_k (\mathbf{u}_k \cdot \nabla p_s + p_s \nabla \cdot \mathbf{u}_k)\]</p><p>Using the logarithm of pressure <span>$\ln p$</span> as the vertical coordinate this becomes</p><p class="math-container">\[\frac{\partial \ln p_s}{\partial t} = 
-\sum_{k=1}^N \sigma_k (\mathbf{u}_k \cdot \nabla \ln p_s + \nabla \cdot \mathbf{u}_k)\]</p><p>The second term is the divergence <span>$\mathcal{D}_k$</span> at layer <span>$k$</span>. We introduce <span>$\bar{a} = \sum_k \Delta \sigma_k a_k$</span>, the <span>$\sigma$</span>-weighted vertical integration operator applied to some variable <span>$a$</span>. This is essentially an average as <span>$\sum_k \Delta \sigma_k = 1$</span>. The surface pressure tendency can then be written as</p><p class="math-container">\[\frac{\partial \ln p_s}{\partial t} = 
-\mathbf{\bar{u}} \cdot \nabla \ln p_s - \bar{\mathcal{D}}\]</p><p>which is form used by SpeedyWeather.jl to calculate the tendency of (the logarithm of) surface pressure.</p><p>As we will have <span>$\ln p_s$</span> available in spectral space at the beginning of a time step, the gradient can be easily computed (see <a href="../spectral_transform/#Derivatives-in-spherical-coordinates">Derivatives in spherical coordinates</a>). However, we then need to transform both gradients to grid-point space for the scalar product with  the (vertically <span>$\sigma$</span>-averaged) velocity vector <span>$\mathbf{\bar{u}}$</span> before transforming it back to spectral space where the tendency is needed. In general, we can do the <span>$\sigma$</span>-weighted average in spectral or in grid-point space, although it is computationally cheaper in spectral space. We therefore compute <span>$- \bar{\mathcal{D}}$</span> entirely in spectral space. With <span>$()$</span> denoting spectral space and <span>$[]$</span> grid-point space (hence, <span>$([])$</span> and <span>$[()]$</span> are the transforms in the respective directions) we therefore do</p><p class="math-container">\[\left(\frac{\partial \ln p_s}{\partial t}\right) = 
\left(-\mathbf{\overline{[u]}} \cdot [\nabla (\ln p_s)]\right) - \overline{(\mathcal{D})}\]</p><p>But note that it would also be possible to do</p><p class="math-container">\[\left(\frac{\partial \ln p_s}{\partial t}\right) = 
\left(-\mathbf{\overline{[u]}} \cdot [\nabla (\ln p_s)] - \overline{[\mathcal{D}]}\right)\]</p><p>Meaning that we would compute the vertical average in grid-point space, subtract from the pressure gradient flux before transforming to spectral space. The same amount of transforms are performed but in the latter, the vertical averaging is done in grid-point space.</p><div class="admonition is-warning"><header class="admonition-header">Semi-implicit time integration: Surface pressure tendency</header><div class="admonition-body"><p>With the semi-implicit time integration in SpeedyWeather the <span>$- \overline{(\mathcal{D})}$</span> term is not evaluated from the spectral divergence <span>$\mathcal{D}$</span> at the current, but at the previous time step. This is because this is a linear term that we solve implicitly to avoid instabilities from gravity waves. For details see section <a href="#implicit_primitive">Semi-implicit time stepping</a>.</p></div></div><h2 id="Vertical-advection"><a class="docs-heading-anchor" href="#Vertical-advection">Vertical advection</a><a id="Vertical-advection-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-advection" title="Permalink"></a></h2><p>The advection equation <span>$\tfrac{DT}{Dt} = 0$</span> for a tracer <span>$T$</span> is, in flux form, for layer <span>$k$</span></p><p class="math-container">\[\frac{\partial (T_k \Delta p_k)}{\partial t} = - \nabla \cdot (\mathbf{u}_k T_k \Delta p_k)
- (M_{k+\tfrac{1}{2}}T_{k+\tfrac{1}{2}} - M_{k-\tfrac{1}{2}}T_{k-\tfrac{1}{2}})\]</p><p>which can be through the gradient product rule, and using the conservation of mass (see <a href="#Vertical-velocity">Vertical velocity</a>) transformed into an advective form. In sigma coordinates this simplifies to</p><p class="math-container">\[\frac{\partial T_k}{\partial t} = - \mathbf{u}_k \cdot \nabla T_k
- \frac{1}{\Delta \sigma_k}\left(\dot{\sigma}_{k+\tfrac{1}{2}}(T_{k+\tfrac{1}{2}} - T_k) - \dot{\sigma}_{k-\tfrac{1}{2}}(T_k - T_{k-\tfrac{1}{2}})\right)\]</p><p>With the reconstruction at the faces, <span>$T_{k+\tfrac{1}{2}}$</span>, and <span>$T_{k-\tfrac{1}{2}}$</span> depending on one&#39;s choice of the advection scheme. For a second order centered scheme, we choose <span>$T_{k+\tfrac{1}{2}} = \tfrac{1}{2}(T_k + T_{k+1})$</span> and obtain</p><p class="math-container">\[\frac{\partial T_k}{\partial t} = - \mathbf{u}_k \cdot \nabla T_k
- \frac{1}{2\Delta \sigma_k}\left(\dot{\sigma}_{k+\tfrac{1}{2}}(T_{k+1} - T_k) + \dot{\sigma}_{k-\tfrac{1}{2}}(T_k - T_{k-1})\right)\]</p><p>However, note that this scheme is dispersive and easily leads to instabilities at higher resolution, where a more advanced vertical advection scheme becomes necessary. For convenience, we may write <span>$W(T)$</span> to denote the vertical advection term <span>$\dot{\sigma}\partial_\sigma T$</span>, without specifying which schemes is used. The vertical velocity <span>$\dot{\sigma}$</span> is calculated as described in the following.</p><h3 id="Vertical-velocity"><a class="docs-heading-anchor" href="#Vertical-velocity">Vertical velocity</a><a id="Vertical-velocity-1"></a><a class="docs-heading-anchor-permalink" href="#Vertical-velocity" title="Permalink"></a></h3><p>In the section <a href="#Surface-pressure-tendency">Surface pressure tendency</a> we used that the surface pressure changes with the convergence of the flow above, which derives from the conservation of mass. Similarly, the conservation of mass for layer <span>$k$</span> can be expressed as (setting <span>$T=1$</span> in the advection equation in section <a href="#Vertical-advection">Vertical advection</a>)</p><p class="math-container">\[\frac{\partial \Delta p_k}{\partial t} = -\nabla \cdot (\mathbf{u}_k \Delta p_k)
- (M_{k+\tfrac{1}{2}} - M_{k-\tfrac{1}{2}})\]</p><p>Meaning that the pressure thickness <span>$\Delta p_k$</span> of layer <span>$k$</span> changes with a horizontal divergence <span>$-\nabla \cdot (\mathbf{u}_k \Delta p_k)$</span> if not balanced by a net vertical mass flux <span>$M$</span> into of the layer through the bottom and top boundaries of <span>$k$</span> at <span>$k\pm\tfrac{1}{2}$</span>. <span>$M$</span> is defined positive downward as this is the direction in which both pressure and sigma coordinates increase. The boundary conditions are <span>$M_\tfrac{1}{2} = M_{N+\tfrac{1}{2}} = 0$</span>, such that there is no mass flux into the top layer from above or out of the surface layer <span>$N$</span> and into the ground or ocean.</p><p>When integrating from the top down to layer <span>$k$</span> we obtain the mass flux downwards out of layer <span>$k$</span></p><p class="math-container">\[M_{k+\tfrac{1}{2}} = - \sum_{r=1}^k \nabla \cdot (\mathbf{u}_k \Delta p_k) - \frac{\partial p_{k+\tfrac{1}{2}}}{\partial t}\]</p><p>In sigma coordinates we have <span>$M_{k+\tfrac{1}{2}} = p_s \dot{\sigma}_{k+\tfrac{1}{2}}$</span> with <span>$\dot{\sigma}$</span> being the vertical velocity in sigma coordinates, also defined at interfaces between layers. To calculate <span>$\dot{\sigma}$</span> we therefore compute</p><p class="math-container">\[\dot{\sigma}_{k+\tfrac{1}{2}} = \frac{M_{k+\tfrac{1}{2}}}{p_s} = 
- \sum_{r=1}^k \Delta \sigma_r (\mathbf{u}_k \cdot \nabla \ln p_s + \mathcal{D}_r) 
+ \sigma_{k+\tfrac{1}{2}}(-\mathbf{\bar{u}} \cdot \nabla \ln p_s - \bar{\mathcal{D}})\]</p><p>With <span>$\bar{A}$</span> denoting a sigma thickness-weighted vertical average as in section <a href="#Surface-pressure-tendency">Surface pressure tendency</a>. Now let <span>$\bar{A_k}$</span> be that average from <span>$r=1$</span> to <span>$r=k$</span> only and not necessarily down to the surface, as required in the equation above, then we can also write</p><p class="math-container">\[\dot{\sigma}_{k+\tfrac{1}{2}} = 
- \overline{\mathbf{u}_k \cdot \nabla \ln p_s} - \bar{\mathcal{D}}_k
+ \sigma_{k+\tfrac{1}{2}}(-\mathbf{\bar{u}} \cdot \nabla \ln p_s - \bar{\mathcal{D}})\]</p><p>See also Hoskins and Simmons, 1975<sup class="footnote-reference"><a id="citeref-HS75" href="#footnote-HS75">[HS75]</a></sup>. These vertical averages are the same as required by the  <a href="#Surface-pressure-tendency">Surface pressure tendency</a> and in the <a href="#Temperature-equation">Temperature equation</a>, they are therefore all calculated at once, storing the partial averages <span>$\overline{\mathbf{u}_k \cdot \nabla \ln p_s}$</span> and <span>$\bar{\mathcal{D}}_k$</span> on the fly.</p><h2 id="Pressure-gradient"><a class="docs-heading-anchor" href="#Pressure-gradient">Pressure gradient</a><a id="Pressure-gradient-1"></a><a class="docs-heading-anchor-permalink" href="#Pressure-gradient" title="Permalink"></a></h2><p>The pressure gradient term in the primitive equations is</p><p class="math-container">\[-\frac{1}{\rho}\nabla_z p\]</p><p>with density <span>$\rho$</span> and pressure <span>$p$</span>. The gradient here is taken at constant <span>$z$</span> hence the subscript. If we move to a pressure-based vertical coordinate system we will need to evaluate gradients on constant levels of pressure though, i.e. <span>$\nabla_p$</span>. There is, by definition, no gradient of pressure on constant levels of pressure, but we can use the chain rule (see  <a href="#Vertical-coordinates">Vertical coordinates</a>) to rewrite this as (use only <span>$x$</span> but <span>$y$</span> is equivalent)</p><p class="math-container">\[0 = \left. \frac{\partial p}{\partial x} \right\vert_p =
\left. \frac{\partial p}{\partial x} \right\vert_z +
\frac{\partial p}{\partial z}\left. \frac{\partial z}{\partial x} \right\vert_p\]</p><p>Using the hydrostatic equation <span>$\partial_z p = -\rho g$</span> this becomes</p><p class="math-container">\[\left. \frac{\partial p}{\partial x} \right\vert_z = \rho g \left. \frac{\partial z}{\partial x} \right\vert_p\]</p><p>Or, in terms of the geopotential <span>$\Phi = gz$</span></p><p class="math-container">\[\frac{1}{\rho}\nabla_z p = \nabla_p \Phi\]</p><p>which is the actual reason why we use pressure coordinates: As density <span>$\rho$</span> also depends on the pressure <span>$p$</span> the left-hand side means an implicit system when solving for pressure <span>$p$</span>. To go from pressure to sigma coordinates we apply the chain rule from section <a href="#Vertical-coordinates">Vertical coordinates</a> again and obtain</p><p class="math-container">\[\nabla_p \Phi = \nabla_\sigma \Phi - \frac{\partial \Phi}{\partial p}\nabla_\sigma p
= \nabla_\sigma \Phi + \frac{1}{\rho}\nabla_\sigma p\]</p><p>where the last step inserts the hydrostatic equation again. With the ideal gas law, and note that we use <a href="#Virtual-temperature">Virtual temperature</a> <span>$T_v$</span> everywhere where the ideal gas law is used, but in combination with the dry gas constant <span>$R_d$</span></p><p class="math-container">\[\nabla_p \Phi = \nabla_\sigma \Phi + \frac{R_dT_v}{p} \nabla_\sigma p\]</p><p>Combining the pressure in denominator and gradient to the logarithm and with <span>$\nabla \ln p = \nabla \ln p_s$</span> in <a href="#Sigma-coordinates">Sigma coordinates</a> (the logarithm of <span>$\sigma_k$</span> adds a constant that drops out in the gradient) we therefore have</p><p class="math-container">\[- \frac{1}{\rho}\nabla_z p = -\nabla_p \Phi = -\nabla_\sigma \Phi - R_dT_v \nabla_\sigma \ln p_s\]</p><p>From left to right: The pressure gradient force in <span>$z$</span>-coordinates; in pressure coordinates; and in sigma coordinates. Each denoted with the respective subscript on gradients.  SpeedyWeather.jl uses the latter. In sigma coordinates we may drop the <span>$\sigma$</span> subscript on gradients, but still meaning that the gradient is evaluated on a surface of our vertical coordinate. In vorticity-divergence formulation of the momentum equations the <span>$\nabla_\sigma \Phi$</span> drops out in the vorticity equation (<span>$\nabla \times \nabla \Phi = 0$</span>), but becomes a <span>$-\nabla^2 \Phi$</span> in the divergence equation, which is therefore combined with the kinetic energy term <span>$-\nabla^2(\tfrac{1}{2}(u^2 + v^2))$</span> similar as it is done in the <a href="../shallowwater/#Shallow-water-equations">Shallow water equations</a>. You can think of <span>$\tfrac{1}{2}(u^2 + v^2) + \Phi$</span> as the Bernoulli potential in the primitive equations. However, due to the change into sigma coordinates the surface pressure gradient also has to be accounted for. Now highlighting only the pressure gradient force, we have in total</p><p class="math-container">\[\begin{aligned}
\frac{\partial \zeta}{\partial t} &amp;= \nabla \times (... - R_dT_v\nabla \ln p_s) + ... \\
\frac{\partial \mathcal{D}}{\partial t} &amp;= \nabla \cdot (... - R_dT_v\nabla \ln p_s) - \nabla^2\Phi + ...
\end{aligned}\]</p><p>In our vorticity-divergence formulation and with sigma coordinates.</p><h3 id="Semi-implicit-pressure-gradient"><a class="docs-heading-anchor" href="#Semi-implicit-pressure-gradient">Semi-implicit pressure gradient</a><a id="Semi-implicit-pressure-gradient-1"></a><a class="docs-heading-anchor-permalink" href="#Semi-implicit-pressure-gradient" title="Permalink"></a></h3><p>With the <a href="#implicit_primitive">semi-implicit time integration</a> in SpeedyWeather.jl the pressure gradient terms are further modified as follows. See that section for details why, but here is just to mention that we need to split the terms into linear and non-linear terms. The linear terms are then evaluated at the previous time step for the implicit scheme such that we can avoid instabilities from gravity waves.</p><p>We split the (virtual) temperature into a reference vertical profile <span>$T_k$</span> and its anomaly, <span>$T_v = T_k + T_v&#39;$</span>. The reference profile <span>$T_k$</span> has to be a global constant for the spectral transform but can depend on the vertical. With this, the previous equation becomes</p><p class="math-container">\[\begin{aligned}
\frac{\partial \zeta}{\partial t} &amp;= \nabla \times (... - R_dT_v&#39;\nabla \ln p_s) + ... \\
\frac{\partial \mathcal{D}}{\partial t} &amp;= \nabla \cdot (... - R_dT_v&#39;\nabla \ln p_s) - \nabla^2(\Phi + R_d T_k \ln p_s) + ...
\end{aligned}\]</p><p>In the vorticity equation the term with the reference profile drops out as <span>$\nabla \times \nabla = 0$</span>, and in the divergence equation we move it into the Laplace operator. Now the linear terms are gathered with the Laplace operator and for the semi-implicit scheme we calculate both the <a href="#Geopotential">Geopotential</a> <span>$\Phi$</span> and the contribution to the &quot;linear pressure gradient&quot; <span>$R_dT_k \ln p_s$</span> at the previous time step for the <a href="#implicit_primitive">semi-implicit time integration</a> for details see therein.</p><h2 id="Vorticity-advection"><a class="docs-heading-anchor" href="#Vorticity-advection">Vorticity advection</a><a id="Vorticity-advection-1"></a><a class="docs-heading-anchor-permalink" href="#Vorticity-advection" title="Permalink"></a></h2><p>Vorticity advection in the primitive equation takes the form</p><p class="math-container">\[\begin{aligned}
\frac{\partial u}{\partial t} &amp;= (f+\zeta)v \\
\frac{\partial v}{\partial t} &amp;= -(f+\zeta)u \\
\end{aligned}\]</p><p>Meaning that we add the Coriolis parameter <span>$f$</span> and the relative vorticity <span>$\zeta$</span> and multiply by the respective velocity component. While the primitive equations here are written with vorticity and divergence, we use <span>$u,v$</span> here as other tendencies will be added and the curl and divergence are only taken once after transform into spectral space. To obtain a tendency for vorticity and divergence, we rewrite this as</p><p class="math-container">\[\begin{aligned}
\frac{\partial \zeta}{\partial t} &amp;= \nabla \times (f+\zeta)\mathbf{u}_\perp \\
\frac{\partial \mathcal{D}}{\partial t} &amp;= \nabla \cdot (f+\zeta)\mathbf{u}_\perp \\
\end{aligned}\]</p><p>with <span>$\mathbf{u}_\perp = (v,-u)$</span> the rotated velocity vector, see <a href="../barotropic/#Barotropic-vorticity-equation">Barotropic vorticity equation</a>.</p><h2 id="Humidity-equation"><a class="docs-heading-anchor" href="#Humidity-equation">Humidity equation</a><a id="Humidity-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Humidity-equation" title="Permalink"></a></h2><p>The dynamical core treats humidity as an (active) tracer, meaning that after the physical parameterizations for humidity <span>$\mathcal{P}$</span> are calculated in grid-point space, humidity is only advected with the flow. The only exception is the <a href="#Virtual-temperature">Virtual temperature</a> as high levels of humidity will lower the effective density, which is why we use the virtual instead of the absolute temperature. The equation to be solved for humidity is therefore,</p><p class="math-container">\[\left( \frac{\partial q}{\partial t} \right) = \left(\left[\mathcal{P}_q - W_q +
q\mathcal{D} \right]\right) -\nabla\cdot([\mathbf{u}q])\]</p><p>With <span>$()$</span> denoting spectral space and <span>$[]$</span> grid-point space, so that <span>$([])$</span> and <span>$[()]$</span> are the transforms in the respective directions. To avoid confusion with that notation, we write the tendency of humidity due to <a href="#Vertical-advection">Vertical advection</a> as <span>$W_q$</span>. This equation is identical to a tracer equation, with <span>$\mathcal{P}_q$</span> denoting sources and sinks. Note that <a href="#Horizontal-diffusion">Horizontal diffusion</a> should be applied to every advected variable.</p><p>A very similar equation is solved for (absolute) temperature as described in the following.</p><h2 id="Temperature-equation"><a class="docs-heading-anchor" href="#Temperature-equation">Temperature equation</a><a id="Temperature-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Temperature-equation" title="Permalink"></a></h2><p>The first law of thermodynamic states that the internal energy <span>$I$</span> is increased by the heat <span>$Q$</span> applied minus the work <span>$W$</span> done by the system. We neglect changes in chemical composition (<sup class="footnote-reference"><a id="citeref-Vallis" href="#footnote-Vallis">[Vallis]</a></sup>, chapter 1.5). For an ideal gas, the internal  energy is <span>$c_vT$</span> with <span>$c_v$</span> the heat capacity at constant volume and temperature <span>$T$</span>. The work done is <span>$pV$</span>, with pressure <span>$p$</span> and the specific volume <span>$V$</span></p><p class="math-container">\[dI = Q - p dV.\]</p><p>For fluids we replace the differential <span>$d$</span> here with the material derivative <span>$\tfrac{D}{Dt}$</span>. With <span>$V = \tfrac{1}{\rho}$</span> and density <span>$\rho$</span> we then have</p><p class="math-container">\[c_v \frac{DT}{Dt} = -p \frac{D (1/\rho)}{Dt} + Q\]</p><p>Using the ideal gas law to replace <span>$\tfrac{1}{\rho}$</span> with <span>$\tfrac{RT_v}{p}$</span> (we are using the <a href="#Virtual-temperature">Virtual temperature</a> again), and using</p><p class="math-container">\[p\frac{D (1/p)}{Dt} = -\frac{1}{p} \frac{Dp}{Dt}\]</p><p>we have</p><p class="math-container">\[(c_v + R)\frac{DT}{Dt} = \frac{RT_v}{p}\frac{Dp}{Dt} + Q\]</p><p>And further, with <span>$c_p = c_v + R$</span> the heat capacity at constant pressure, <span>$\kappa = \tfrac{R}{c_p}$</span>, and using the logarithm of pressure</p><p class="math-container">\[\frac{DT}{Dt} = \kappa T_v\frac{D \ln p}{Dt} + \frac{Q}{c_p}\]</p><p>This is the form of the temperature equation that SpeedyWeather.jl uses. Temperature is advected through the material derivative and first term on the right-hand side represents an adiabatic conversion term describing how the temperature changes with changes in pressure. Recall that this term originated from the work term in the first law of thermodynamics. The forcing term <span>$\tfrac{Q}{c_p}$</span> is here identified as the physical parameterizations changing the temperature, for example radiation, and hence we will call it <span>$P_T$</span>.</p><p>Similar to the <a href="#Humidity-equation">Humidity equation</a> we write the equation for (absolute) temperature <span>$T$</span> as</p><p class="math-container">\[\left( \frac{\partial T}{\partial t} \right) = \left(\left[\mathcal{P}_T - W_T +
T\mathcal{D} + \kappa T_v \frac{D \ln p}{Dt} \right]\right) -\nabla\cdot([\mathbf{u}T])\]</p><p><span>$W_T$</span> is the <a href="#Vertical-advection">Vertical advection</a> of temperature. We evaluate the adiabatic conversion term completely in grid-point space following Simmons and Burridge, 1981<sup class="footnote-reference"><a id="citeref-SB81" href="#footnote-SB81">[SB81]</a></sup> Equation 3.12 and 3.13. Leaving out the <span>$\kappa T_v$</span> for clarity, the term at level <span>$k$</span> is</p><p class="math-container">\[\left(\frac{D \ln p}{D t}\right)_k = \mathbf{u}_k \cdot \nabla \ln p_k
- \frac{1}{\Delta p_k} \left[\left( \ln \frac{p_{k+\tfrac{1}{2}}}{p_{k-\tfrac{1}{2}}}\right)
\sum_{r=1}^{k-1}\nabla \cdot (\mathbf{u}_k \Delta p_k) + \alpha_k \nabla \cdot (\mathbf{u}_k \Delta p_k) \right]\]</p><p>with</p><p class="math-container">\[\alpha_k = 1 - \frac{p_{k-\tfrac{1}{2}}}{\Delta p_k} \ln \frac{p_{k+\tfrac{1}{2}}}{p_{k-\tfrac{1}{2}}}\]</p><p>In sigma coordinates this simplifies to, following similar steps as in <a href="#Surface-pressure-tendency">Surface pressure tendency</a></p><p class="math-container">\[\begin{aligned}
\left(\frac{D \ln p}{D t}\right)_k &amp;= \mathbf{u}_k \cdot \nabla \ln p_s \\
&amp;- \frac{1}{\Delta \sigma_k} \left( \ln \frac{\sigma_{k+\tfrac{1}{2}}}{\sigma_{k-\tfrac{1}{2}}}\right)
\sum_{r=1}^{k-1}\Delta \sigma_r (\mathcal{D}_r + \mathbf{u}_r \cdot \nabla \ln p_s) -
\alpha_k (\mathcal{D}_k + \mathbf{u}_k \cdot \nabla \ln p_s)
\end{aligned}\]</p><p>Let <span>$A_k = \mathcal{D}_k + \mathbf{u}_k \cdot \nabla \ln p_s$</span> and <span>$\beta_k = \tfrac{1}{\Delta \sigma_k} \left( \ln \tfrac{\sigma_{k+\tfrac{1}{2}}}{\sigma_{k-\tfrac{1}{2}}}\right)$</span>, then this can also be summarised as</p><p class="math-container">\[\left(\frac{D \ln p}{D t}\right)_k = \mathbf{u}_k \cdot \nabla \ln p_s
- \beta_k \sum_{r=1}^{k-1}\Delta \sigma_r A_r - \alpha_k A_k\]</p><p>The <span>$\alpha_k, \beta_k$</span> are constants and can be precomputed. The surface pressure flux <span>$\mathbf{u}_k \cdot \nabla \ln p_s$</span> has to be computed, so does the vertical sigma-weighted average from top to <span>$k-1$</span>, which is done when computing other vertical averages for the <a href="#Surface-pressure-tendency">Surface pressure tendency</a>.</p><h3 id="Semi-implicit-temperature-equation"><a class="docs-heading-anchor" href="#Semi-implicit-temperature-equation">Semi-implicit temperature equation</a><a id="Semi-implicit-temperature-equation-1"></a><a class="docs-heading-anchor-permalink" href="#Semi-implicit-temperature-equation" title="Permalink"></a></h3><p>For the <a href="#implicit_primitive">semi-implicit scheme</a> we need to split the temperature equation into linear and non-linear terms, as the linear terms need to be evaluated at the previous time step. Decomposing temperature <span>$T$</span> into <span>$T = T_k + T&#39;$</span> with the reference profile <span>$T_k$</span> and its anomaly <span>$T&#39;$</span>, the temperature equation becomes</p><p class="math-container">\[\left( \frac{\partial T}{\partial t} \right) = \mathcal{P}_T - W_T +
T&#39;\mathcal{D} + \kappa T_v \frac{D \ln p}{Dt} -\nabla\cdot(\mathbf{u}T&#39;)\]</p><p>Note that we do not change the adiabatic conversion term. While its linear component <span>$\kappa T_k^v \tfrac{D \ln p_s}{D t}$</span> (the subscript <span>$v$</span> for <a href="#Virtual-temperature">Virtual temperature</a> as been raised) would need to be evaluated at the previous time step, we still evaluate this term at the current time step and move it within the semi-implicit corrections to the previous time step afterwards.</p><h2 id="implicit_primitive"><a class="docs-heading-anchor" href="#implicit_primitive">Semi-implicit time stepping</a><a id="implicit_primitive-1"></a><a class="docs-heading-anchor-permalink" href="#implicit_primitive" title="Permalink"></a></h2><p>Conceptually, the semi-implicit time stepping in the <a href="#Primitive-equation-model">Primitive equation model</a> is the same as in the <a href="../shallowwater/#implicit_swm">Shallow water model</a>, but</p><ul><li>tendencies for divergence <span>$\mathcal{D}$</span>, logarithm of surface pressure <span>$\ln p_s$</span> but also temperature <span>$T$</span> are computed semi-implicitly,</li><li>the vertical layers are coupled, creating a linear equation system that is solved via matrix inversion.</li></ul><p>The linear terms of the primitive equations follow a linearization around a state of rest without orography and a reference vertical temperature profile. The scheme described here largely follows Hoskins and Simmons <sup class="footnote-reference"><a id="citeref-HS75" href="#footnote-HS75">[HS75]</a></sup>, which has also been used in Simmons and Burridge <sup class="footnote-reference"><a id="citeref-SB81" href="#footnote-SB81">[SB81]</a></sup>.</p><p>As before, let <span>$\delta V = \tfrac{V_{i+1} - V_{i-1}}{2\Delta t}$</span> be the tendency we need for the Leapfrog time stepping. With the implicit time step <span>$\xi = 2\alpha\Delta t$</span>, <span>$\alpha \in [\tfrac{1}{2},1]$</span> we have</p><p class="math-container">\[\delta V = N_E(V_i) + N_I(V_{i-1}) + \xi N_I(\delta V)\]</p><p>with <span>$N_E$</span> being the explicitly-treated non-linear terms and <span>$N_I$</span> the implicitly-treated linear terms, such that <span>$N_I$</span> is a linear operator. We can therefore solve for <span>$\delta V$</span> by inverting <span>$N_I$</span>, </p><p class="math-container">\[\delta V = (1-\xi N_I)^{-1}G\]</p><p>where we gathered the uncorrected right-hand side as <span>$G$</span></p><p class="math-container">\[G = N_E(V_i) + N_I(V_{i-1}) = N(V_i) + N_I(V_{i-1} - V_i).\]</p><p>So for every linear term in <span>$N_I$</span> we have two options corresponding to two sides of this equation</p><ol><li>Evaluate it at the previous time step <span>$i-1$</span></li><li>Or, evaluate it at the current time step <span>$i$</span> as <span>$N(V_i)$</span>, but then move it back to the previous time step <span>$i-1$</span> by adding (in spectral space) the linear operator <span>$N_I$</span> evaluated with the difference between the two time steps.</li></ol><p>If there is a tendency that is easily evaluated in spectral space it is easier to follow 1. However, a term that is costly to evaluate in grid-point space should usually follow the latter. The reason is that the previous time step is generally not available in grid-point space (unless recalculated through a costly transform or stored with additional memory requirements) so it is easier to follow 2 where the <span>$N_I$</span> is available in spectral space. For the adiabatic conversion term in the <a href="#Temperature-equation">Temperature equation</a> we follow 2 as one would otherwise need to split this term into a non-linear and linear term, evaluating it essentially twice in grid-point space. </p><p>So what is <span>$G$</span> in the <a href="#Primitive-equation-model">Primitive equation model</a>? </p><p class="math-container">\[\begin{aligned}
G_\mathcal{D} &amp;= N^E_\mathcal{D} - \nabla^2(\Phi^{i-1} + R_dT_k^v (\ln p_s)^{i-1})
= N^E_\mathcal{D} - \nabla^2( \mathbf{R}T^{i-1} + \mathbf{U}\ln p_s^{i-1}) \\
G_{\ln p_s} &amp;= N_{\ln p_s}^E - \overline{\mathcal{D}^{i-1}}
= N_{\ln p_s}^E + \mathbf{W}\mathcal{D}^{i-1} \\
G_T &amp;= N_T + \mathbf{L}(\mathcal{D}^{i-1} - \mathcal{D}^i) \\
\end{aligned}\]</p><p><span>$G$</span> is for the divergence, pressure and temperature equation the &quot;uncorrected&quot; tendency. Moving time step <span>$i - 1 \to i$</span> we would be back with a fully explicit scheme. In the divergence equation the <a href="#Geopotential">Geopotential</a> <span>$\Phi$</span> is calculated from temperature <span>$T$</span> at the previous time step <span>$i-1$</span> (denoted as superscript) and the &quot;linear&quot; <a href="#Pressure-gradient">Pressure gradient</a> from the logarithm of surface pressure at the previous time step. One can think of these two calculations as linear operators, <span>$\mathbf{R}$</span> and <span>$\mathbf{U}$</span>. We will shortly discuss their properties. While we could combine them with the Laplace operator <span>$\nabla^2$</span> (which is also linear) we do not do this as <span>$\mathbf{R, U}$</span> do not depend on the degree and order of the spherical harmonics (their <em>wavenumber</em>) but on the vertical, but <span>$\nabla^2$</span> does not depend on the vertical, only on the wavenumber. All other terms are gathered in <span>$N_\mathcal{D}^E$</span> (subscript <span>$E$</span> has been raised) and calculated as described in the respective section at the current time step <span>$i$</span>.</p><p>For the pressure tendency, the subtraction with the thickness-weighted vertical average <span>$\bar{\mathcal{D}}$</span> is the linear term that is treated implicitly. We call this operator <span>$\mathbf{W}$</span>. For the temperature tendency, we evaluate all terms explicitly at the current time step in <span>$N_T$</span> but then move the linear term in the adiabatic conversion term with the operator <span>$\mathbf{L}$</span> back to the previous time step. For details see <a href="#Semi-implicit-temperature-equation">Semi-implicit temperature equation</a>.</p><p>The operators <span>$\mathbf{R, U, L, W}$</span> are all linear, meaning that we can apply them  in spectral space to each spherical harmonic independently – the vertical is coupled however. With <span>$N$</span> being the number of vertical levels and the prognostic variables like temperature for a given degree <span>$l$</span> and order <span>$m$</span> being a column vector in the vertical, <span>$T_{l,m} \in \mathbb{R}^N$</span>, these operators have the following shapes</p><p class="math-container">\[\begin{aligned}
\mathbf{R} &amp;\in \mathbb{R}^{N\times N} \\
\mathbf{U} &amp;\in \mathbb{R}^{N\times 1} \\
\mathbf{L} &amp;\in \mathbb{R}^{N\times N} \\
\mathbf{W} &amp;\in \mathbb{R}^{1\times N} \\
\end{aligned}\]</p><p><span>$\mathbf{R}$</span> is an integration in the vertical hence it is an upper triangular matrix such that the first (an top-most) <span>$k=1$</span> element of the resulting vector depends on all vertical levels of the temperature mode <span>$T_{l,m}$</span>, but the surface <span>$k=N$</span> only on the temperature mode at the surface. <span>$\mathbf{U}$</span> takes the surface value of the <span>$l,m$</span> mode of the logarithm of surface pressure <span>$(\ln p_s)_{l,m}$</span> and multiplies it element-wise with the reference temperature profile and the dry gas constant. So the result is a column vector. <span>$\mathbf{L}$</span> is an <span>$N \times N$</span> matrix as the adiabatic conversion term couples all layers. <span>$\mathbf{W}$</span> is a row vector as it represents the vertical averaging of the spherical harmonics of a divergence profile. So, <span>$\mathbf{W}\mathcal{D}$</span> is a scalar product for every <span>$l,m$</span> giving a contribution of all vertical layers in divergence to the (single-layer!) logarithm of surface pressure tendency.</p><p>With the <span>$G$</span>s defined we can now write the semi-implicit tendencies <span>$\delta \mathcal{D}$</span>, <span>$\delta T$</span>, <span>$\delta \ln p_s$</span> as (first equation in this section)</p><p class="math-container">\[\begin{aligned}
\delta \mathcal{D} &amp;= G_D - \xi \nabla^2(\mathbf{R}\delta T + \mathbf{U} \delta \ln p_s)\\
\delta T &amp;= G_T + \xi \mathbf{L}\delta \mathcal{D} \\
\delta \ln p_s &amp;= G_{\ln p_s} + \xi \mathbf{W}\delta \mathcal{D}
\end{aligned}\]</p><p>Solving for <span>$\delta \mathcal{D}$</span> with the &quot;combined&quot; tendency</p><p class="math-container">\[G = G_D - \xi \nabla^2(\mathbf{R}G_T + \mathbf{U}G_{\ln p_s})\]</p><p>via</p><p class="math-container">\[\delta \mathcal{D} = G - \xi^2\nabla^2(\mathbf{RL + UW})\delta \mathcal{D}\]</p><p>(<span>$\mathbf{UW}$</span> is a matrix of size <span>$N \times N$</span>) yields</p><p class="math-container">\[\delta D = \left( 1 + \xi^2\nabla^2(\mathbf{RL + UW})  \right)^{-1}G = \mathbf{S}^{-1}G\]</p><p>The other tendencies <span>$\delta T$</span> and <span>$\delta \ln p_s$</span> are then obtained through insertion above. We may call the operator to be inverted <span>$\mathbf{S}$</span> which is of size <span>$l_{max} \times N \times N$</span>, hence for every degree <span>$l$</span> of the spherical harmonics (which the Laplace operator depends on) a <span>$N \times N$</span> matrix coupling the <span>$N$</span> vertical levels. Furthermore, <span>$S$</span> depends</p><ul><li>through <span>$\xi$</span> on the time step <span>$\Delta t$</span>,</li><li>through <span>$\mathbf{R,W,L}$</span> on the vertical level spacing <span>$\Delta \sigma_k$</span></li><li>through <span>$\mathbf{U}$</span> on the reference temperature profile <span>$T_k$</span></li></ul><p>so for any changes of these the matrix inversion of <span>$\mathbf{S}$</span> has to be recomputed. Otherwise the algorithm for the semi-implicit scheme is as follows</p><p>0. Precompute the linear operators <span>$\mathbf{R,U,L,W}$</span> and with them the matrix inversion <span>$\mathbf{S}^{-1}$</span>.</p><p>Then for every time step</p><ol><li>Compute the uncorrected tendencies evaluated at the current time step for the explicit terms and the previous time step for the implicit terms.</li><li>Exception in SpeedyWeather.jl is the adiabatic conversion term, which is, using <span>$\mathbf{L}$</span> moved afterwards from the current <span>$i$</span> to the previous time step <span>$i-1$</span>.</li><li>Compute the combined tendency <span>$G$</span> from the uncorrected tendencies <span>$G_\mathcal{D}$</span>, <span>$G_T$</span>, <span>$G_{\ln p_s}$</span>.</li><li>With the inverted operator get the corrected tendency for divergence, <span>$\delta \mathcal{D} = \mathbf{S}^{-1}G$</span>.</li><li>Obtain the corrected tendencies for temperature <span>$\delta T$</span> and surface pressure <span>$\delta \ln p_s$</span> from <span>$\delta \mathcal{D}$</span>.</li><li>Apply <a href="#Horizontal-diffusion">Horizontal diffusion</a> (which is only mentioned here as it further updates the tendencies).</li><li>Use <span>$\delta \mathcal{D}$</span>, <span>$\delta T$</span> and <span>$\delta \ln p_s$</span> in the <a href="../barotropic/#leapfrog">Leapfrog time integration</a>.</li></ol><h2 id="Horizontal-diffusion"><a class="docs-heading-anchor" href="#Horizontal-diffusion">Horizontal diffusion</a><a id="Horizontal-diffusion-1"></a><a class="docs-heading-anchor-permalink" href="#Horizontal-diffusion" title="Permalink"></a></h2><p>Horizontal diffusion in the primitive equations is applied to vorticity <span>$\zeta$</span>, divergence <span>$\mathcal{D}$</span>, temperature <span>$T$</span> and humidity <span>$q$</span>. In short, all variables that are advected. For the dry equations, <span>$q=0$</span> and no diffusion has to be applied.</p><p>The horizontal diffusion is applied implicitly in spectral space, as already described in <a href="#Horizontal-diffusion">Horizontal diffusion</a> for the barotropic vorticity equation.</p><h2 id="Algorithm"><a class="docs-heading-anchor" href="#Algorithm">Algorithm</a><a id="Algorithm-1"></a><a class="docs-heading-anchor-permalink" href="#Algorithm" title="Permalink"></a></h2><p>The following algorithm describes a time step of the <code>PrimitiveWetModel</code>, for the <code>PrimitiveDryModel</code> humidity can be set to zero and respective steps skipped.</p><p>0. Start with initial conditions of relative vorticity <span>$\zeta_{lm}$</span>, divergence <span>$D_{lm}$</span>, temperature <span>$T_{lm}$</span>, humidity <span>$q_{lm}$</span> and the logarithm of surface pressure <span>$(\ln p_s)_{lm}$</span> in spectral space. Variables <span>$\zeta, D, T, q$</span> are defined on all vertical levels, the logarithm of surface pressure only at the surface. Transform this model state to grid-point space, obtaining velocities is done as in the shallow water model</p><ul><li>Invert the <a href="../spectral_transform/#Laplacian">Laplacian</a> of <span>$\zeta_{lm}$</span> to obtain the stream function <span>$\Psi_{lm}$</span> in spectral space</li><li>Invert the <a href="../spectral_transform/#Laplacian">Laplacian</a> of <span>$D_{lm}$</span> to obtain the velocity potential <span>$\Phi_{lm}$</span> in spectral space</li><li>obtain velocities <span>$U_{lm} = (\cos(\theta)u)_{lm}, V_{lm} = (\cos(\theta)v)_{lm}$</span> from <span>$\nabla^\perp\Psi_{lm} + \nabla\Phi_{lm}$</span></li><li>Transform velocities <span>$U_{lm}$</span>, <span>$V_{lm}$</span> to grid-point space <span>$U,V$</span></li><li>Unscale the <span>$\cos(\theta)$</span> factor to obtain <span>$u,v$</span></li></ul><p>Additionally we</p><ul><li>Transform <span>$\zeta_{lm}$</span>, <span>$D_{lm}$</span>, <span>$T_{lm}, (\ln p_s)_{lm}$</span> to <span>$\zeta, D, \eta, T, \ln p_s$</span> in grid-point space</li><li>Compute the (non-linearized) <a href="#Virtual-temperature">Virtual temperature</a> in grid-point space.</li></ul><p>Now loop over</p><ol><li>Compute all tendencies of <span>$u, v, T, q$</span> due to physical parameterizations in grid-point space.</li><li>Compute the gradient of the logarithm of surface pressure <span>$\nabla (\ln p_s)_{lm}$</span> in spectral space and convert the two fields to grid-point space. Unscale the <span>$\cos(\theta)$</span> on the fly.</li><li>For every layer <span>$k$</span> compute the pressure flux <span>$\mathbf{u}_k \cdot \nabla \ln p_s$</span> in grid-point space. </li><li>For every layer <span>$k$</span> compute a linearized <a href="#Virtual-temperature">Virtual temperature</a> in spectral space.</li><li>For every layer <span>$k$</span> compute a temperature anomaly (virtual and absolute) relative to a vertical reference profile <span>$T_k$</span> in grid-point space.</li><li>Compute the <a href="#Geopotential">Geopotential</a> <span>$\Phi$</span> by integrating the virtual temperature vertically in spectral space from surface to top.</li><li>Integrate <span>$u,v,D$</span> vertically to obtain <span>$\bar{u},\bar{v},\bar{D}$</span> in grid-point space and also <span>$\bar{D}_{lm}$</span> in spectral space. Store on the fly also for every layer <span>$k$</span> the partial integration from 1 to <span>$k-1$</span> (top to layer above). These will be used in the adiabatic term of the <a href="#Temperature-equation">Temperature equation</a>.</li><li>Compute the <a href="#Surface-pressure-tendency">Surface pressure tendency</a> with the vertical averages from the previous step. For the <a href="#implicit_primitive">semi-implicit time stepping</a></li><li>For every layer <span>$k$</span> compute the <a href="#Vertical-velocity">Vertical velocity</a>.</li><li>For every layer <span>$k$</span> add the linear contribution of the <a href="#Pressure-gradient">Pressure gradient</a> <span>$RT_k (\ln p_s)_{lm}$</span> to the geopotential <span>$\Phi$</span> in spectral space.</li><li>For every layer <span>$k$</span> compute the <a href="#Vertical-advection">Vertical advection</a> for <span>$u,v,T,q$</span> and add it to the respective tendency.</li><li>For every layer <span>$k$</span> compute the tendency of <span>$u,v$</span> due to <a href="#Vorticity-advection">Vorticity advection</a> and the <a href="#Pressure-gradient">Pressure gradient</a> <span>$RT_v \nabla \ln p_s$</span> and add to the respective existing tendency. Unscale <span>$\cos(\theta)$</span>, transform to spectral space, take curl and divergence to obtain tendencies for <span>$\zeta_{lm},\mathcal{D}_{lm}$</span>.</li><li>For every layer <span>$k$</span> compute the adiabatic term and the horizontal advection in the <a href="#Temperature-equation">Temperature equation</a> in grid-point space, add to existing tendency and transform to spectral.</li><li>For every layer <span>$k$</span> compute the horizontal advection of humidity <span>$q$</span> in the <a href="#Humidity-equation">Humidity equation</a> in grid-point space, add to existing tendency and transform to spectral.</li><li>For every layer <span>$k$</span> compute the kinetic energy <span>$\tfrac{1}{2}(u^2 + v^2)$</span>, transform to spectral and add to the <a href="#Geopotential">Geopotential</a>. For the <a href="#implicit_primitive">semi-implicit time stepping</a> also add the linear pressure gradient calculated from the previous time step. Now apply the Laplace operator and subtract from the divergence tendency.</li><li>Correct the tendencies following the <a href="../shallowwater/#implicit_swm">semi-implicit time integration</a> to prevent fast gravity waves from causing numerical instabilities.</li><li>Compute the <a href="../barotropic/#diffusion">horizontal diffusion</a> for the advected variables <span>$\zeta,\mathcal{D},T,q$</span></li><li>Compute a leapfrog time step as described in <a href="../barotropic/#leapfrog">Time integration</a> with a <a href="../barotropic/#Robert-Asselin-and-Williams-filter">Robert-Asselin and Williams filter</a></li><li>Transform the new spectral state of <span>$\zeta_{lm}$</span>, <span>$\mathcal{D}_{lm}$</span>, <span>$T_{lm}$</span>, <span>$q_{lm}$</span> and <span>$(\ln p_s)_{lm}$</span> to grid-point <span>$u,v,\zeta,\mathcal{D},T,q,\ln p_s$</span> as described in 0.</li><li>Possibly do some output</li><li>Repeat from 1.</li></ol><h2 id="Scaled-primitive-equations"><a class="docs-heading-anchor" href="#Scaled-primitive-equations">Scaled primitive equations</a><a id="Scaled-primitive-equations-1"></a><a class="docs-heading-anchor-permalink" href="#Scaled-primitive-equations" title="Permalink"></a></h2><h2 id="References"><a class="docs-heading-anchor" href="#References">References</a><a id="References-1"></a><a class="docs-heading-anchor-permalink" href="#References" title="Permalink"></a></h2><section class="footnotes is-size-7"><ul><li class="footnote" id="footnote-GFDL1"><a class="tag is-link" href="#citeref-GFDL1">GFDL1</a>Geophysical Fluid Dynamics Laboratory, <a href="https://www.gfdl.noaa.gov/idealized-models-with-spectral-dynamics/">Idealized models with spectral dynamics</a></li><li class="footnote" id="footnote-GFDL2"><a class="tag is-link" href="#citeref-GFDL2">GFDL2</a>Geophysical Fluid Dynamics Laboratory, <a href="https://www.gfdl.noaa.gov/wp-content/uploads/files/user_files/pjp/spectral_core.pdf">The Spectral Dynamical Core</a></li><li class="footnote" id="footnote-Vallis"><a class="tag is-link" href="#citeref-Vallis">Vallis</a>GK Vallis, 2006. <a href="http://vallisbook.org/">Atmopsheric and Ocean Fluid Dynamics</a>, Cambridge University Press.</li><li class="footnote" id="footnote-SB81"><a class="tag is-link" href="#citeref-SB81">SB81</a>Simmons and Burridge, 1981. <em>An Energy and Angular-Momentum Conserving Vertical Finite-Difference Scheme and Hybrid Vertical Coordinates</em>, Monthly Weather Review. DOI: <a href="https://doi.org/10.1175/1520-0493(1981)109&lt;0758:AEAAMC&gt;2.0.CO;2">10.1175/1520-0493(1981)109&lt;0758:AEAAMC&gt;2.0.CO;2</a>.</li><li class="footnote" id="footnote-HS75"><a class="tag is-link" href="#citeref-HS75">HS75</a>Hoskins and Simmons, 1975. <em>A multi-layer spectral model and the semi-implicit method</em>, Quart. J. R. Met. Soc. DOI: <a href="https://doi.org/10.1002/qj.49710142918">10.1002/qj.49710142918</a></li></ul></section></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../shallowwater/">« Shallow water model</a><a class="docs-footer-nextpage" href="../parameterizations/">Parameterizations »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Wednesday 6 December 2023 22:41">Wednesday 6 December 2023</span>. Using Julia version 1.8.5.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
