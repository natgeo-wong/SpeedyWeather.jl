<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Extending SpeedyWeather · SpeedyWeather.jl</title><meta name="title" content="Extending SpeedyWeather · SpeedyWeather.jl"/><meta property="og:title" content="Extending SpeedyWeather · SpeedyWeather.jl"/><meta property="twitter:title" content="Extending SpeedyWeather · SpeedyWeather.jl"/><meta name="description" content="Documentation for SpeedyWeather.jl."/><meta property="og:description" content="Documentation for SpeedyWeather.jl."/><meta property="twitter:description" content="Documentation for SpeedyWeather.jl."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">SpeedyWeather.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../installation/">Installation</a></li><li><a class="tocitem" href="../how_to_run_speedy/">How to run SpeedyWeather.jl</a></li><li><a class="tocitem" href="../setups/">Model setups</a></li><li><a class="tocitem" href="../spectral_transform/">Spherical Harmonic Transform</a></li><li><a class="tocitem" href="../grids/">Grids</a></li><li><a class="tocitem" href="../barotropic/">Barotropic model</a></li><li><a class="tocitem" href="../shallowwater/">Shallow water model</a></li><li><a class="tocitem" href="../primitiveequation/">Primitive equation model</a></li><li><a class="tocitem" href="../parameterizations/">Parameterizations</a></li><li class="is-active"><a class="tocitem" href>Extending SpeedyWeather</a><ul class="internal"><li><a class="tocitem" href="#logic"><span>SpeedyWeather&#39;s modular logic</span></a></li><li><a class="tocitem" href="#Scope-of-variables"><span>Scope of variables</span></a></li><li><a class="tocitem" href="#Custom-forcing:-define"><span>Custom forcing: define</span></a></li><li><a class="tocitem" href="#Custom-forcing:-generator-function"><span>Custom forcing: generator function</span></a></li><li><a class="tocitem" href="#Custom-forcing:-initialize"><span>Custom forcing: initialize</span></a></li><li><a class="tocitem" href="#Custom-forcing:-forcing!-function"><span>Custom forcing: forcing! function</span></a></li><li><a class="tocitem" href="#Custom-forcing:-model-construction"><span>Custom forcing: model construction</span></a></li><li><a class="tocitem" href="#Custom-drag"><span>Custom drag</span></a></li></ul></li><li><a class="tocitem" href="../output/">NetCDF output</a></li><li><a class="tocitem" href="../ringgrids/">Submodule: RingGrids</a></li><li><a class="tocitem" href="../lowertriangularmatrices/">Submodule: LowerTriangularMatrices</a></li><li><a class="tocitem" href="../speedytransforms/">Submodule: SpeedyTransforms</a></li><li><a class="tocitem" href="../functions/">Function and type index</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Extending SpeedyWeather</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Extending SpeedyWeather</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/SpeedyWeather/SpeedyWeather.jl/blob/main/docs/src/extending.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Extending-SpeedyWeather"><a class="docs-heading-anchor" href="#Extending-SpeedyWeather">Extending SpeedyWeather</a><a id="Extending-SpeedyWeather-1"></a><a class="docs-heading-anchor-permalink" href="#Extending-SpeedyWeather" title="Permalink"></a></h1><p>Generally, SpeedyWeather is built in a very modular, extensible way. While that sounds fantastic in general, it does not save you from understanding its <a href="#logic">modular logic</a> before you can extend SpeedyWeather.jl easily yourself. We highly recommend you to read the following sections if you would like to extend SpeedyWeather in some way, but it also gives you a good understanding of how we build SpeedyWeather in the first place. Because in the end there is no difference between internally or externally defined model components. Having said that, there is a question of the <a href="#Scope-of-variables">Scope of variables</a> meaning that some functions or types require its module to be explicitly named, like <code>SpeedyWeather.some_function</code> instead of just <code>some_function</code>. But that&#39;s really it.</p><p>Before and especially after reading this section you are welcome to <a href="https://github.com/SpeedyWeather/SpeedyWeather.jl/issues">raise an issue</a> about whatever you would like to do with SpeedyWeather. We are happy to help.</p><h2 id="logic"><a class="docs-heading-anchor" href="#logic">SpeedyWeather&#39;s modular logic</a><a id="logic-1"></a><a class="docs-heading-anchor-permalink" href="#logic" title="Permalink"></a></h2><p>Almost every component in SpeedyWeather is implemented in three steps:</p><ol><li>Define a new type,</li><li>define its initialization,</li><li>extend a function that defines what it does.</li></ol><p>To be a bit more explicit (Julia always encourages you to think more abstractly, which can be difficult to get started...) we will use the example of defining a new forcing for the <code>Barotropic</code> or <code>ShallowWater</code> models. But the concept is the same whether you want to define a forcing, a drag, or a new parameterization for the primitive equations, etc. In general, you can define a new component also just in a notebook or in the Julia REPL, you do not have to branch off from the repository and write directly into it. However, note the <a href="#Scope-of-variables">Scope of variables</a> if you define a component externally.</p><p>To define a new forcing type, at the most basic level you would do</p><pre><code class="language-julia hljs">struct MyForcing &lt;: AbstractForcing
    # define some parameters and work arrays here
    a::Float64
    v::Vector{Float64}
end</code></pre><p>In Julia this introduces a new (so-called compound) type that is a subtype of <code>AbstractForcing</code>, we have a bunch of these abstract super types defined and you want to piggy-back on them because of multiple-dispatch. This new type could also be  a <code>mutable struct</code>, could have keywords defined with <code>Base.@kwdef</code> and can also be parametric with respect to the number format or grid, but let&#39;s skip those details for now. Conceptually you include into the type any parameters (example the float <code>a</code> here) that you may need and especially those that you want to change. This type will get a user-facing interface so that one can quickly create a new forcing but with altered parameters. Generally you should also include any kind of precomputed or work arrays (here a vector <code>v</code>). For example, you want to apply your forcing only in certain parts of the globe? Then you probably want to define a mask here that somehow includes the information of your region. For a more concrete example see <a href="#Custom-forcing:-define">Custom forcing: define</a>.</p><p>To define the new type&#39;s initialization, at the most basic level you need to extend the <code>initialize!</code> function for this new type</p><pre><code class="language-julia hljs">function initialize!(forcing::MyForcing,model::ModelSetup)
    # fill in/change any fields of your new forcing here
    forcing.v[1] = 1
    # you can use information from other model components too
    forcing.v[2] = model.planet.gravity
end</code></pre><p>This function is called <em>once</em> during model initialisation (which is in fact just the initialisation of all its components, like the forcing here) and it allows you to precompute values or arrays also based on parameters of other model components. Like in this example, we want to use the gravity that is defined in <code>model.planet</code>. If you need a value for gravity in your forcing you could add a gravity field therein, but then if you change <code>planet.gravity</code> this change would not propagate into your forcing! Another example would be to use <code>model.geometry.coslat</code> if you need to use the cosine of latitude for some precomputation, which, however, depends on the resolution and so should not be hardcoded into your forcing.</p><p>As the last step we have to extend the <code>forcing!</code> function which is the function that is called on <em>every</em> step of the time integration. This new method for <code>forcing!</code> needs to have the following function signature</p><pre><code class="language-julia hljs">function forcing!(  diagn::DiagnosticVariablesLayer,
                    progn::PrognosticVariablesLayer,
                    forcing::MyForcing,
                    time::DateTime,
                    model::ModelSetup)
    # whatever the forcing is supposed to do, in the end you want
    # to write into the tendency fields
    diagn.tendencies.u_tend_grid[1] = forcing.a
    diagn.tendencies.v_tend_grid[1] = forcing.a
    diagn.tendencies.vor_tend[1] = forcing.a
end</code></pre><p><code>DiagnosticVariablesLayer</code> is the type of the first argument, because it contains the tendencies you will want to change, so this is supposed to be read and write. The other arguments should be treated read-only. You make use of the <code>time</code> or anything else in the <code>model</code>, but the latter likely comes with a performance penalty which is why we often unpack the model in a function barrier. But let&#39;s skip that detail for now. Generally, try to precompute what you can in <code>initialize!</code>. For the forcing you will need to force the velocities <code>u,v</code> in grid-point space or the vorticity <code>vor</code>, divergence <code>div</code> in spectral space. This is not a constrain in most applications we came across, but in case it is in yours please reach out.</p><h2 id="Scope-of-variables"><a class="docs-heading-anchor" href="#Scope-of-variables">Scope of variables</a><a id="Scope-of-variables-1"></a><a class="docs-heading-anchor-permalink" href="#Scope-of-variables" title="Permalink"></a></h2><p>The above (conceptual!) examples leave out some of the details, particularly around the scope of variables when you want to define a new forcing interactively inside a notebook or the REPL (which is actually the recommended way!!). To respect the scope of variables, a bunch of functions will need their module to be explicit specified. In general, you should be familiar with Julia&#39;s  <a href="https://docs.julialang.org/en/v1/manual/variables-and-scoping/">scope of variables</a> logic.</p><p>Defining a new type for example as a subtype of AbstractForcing, you will actually want to do</p><pre><code class="language-julia hljs">struct MyForcing &lt;: SpeedyWeather.AbstractForcing
    # fields
end</code></pre><p>Because <code>AbstractForcing</code> is defined inside SpeedyWeather, but we do not export all functions/types in order to not flood your global scope to avoid naming conflicts. Rule of thumb: If you get an error hinting at something is not defined, make sure you are in the right scope!</p><p>Then the <code>initialize!</code> function is a function <em>inside</em> the SpeedyWeather module, as we want to define a new method for it <em>outside</em> that can be called <em>inside</em> we actually need to write</p><pre><code class="language-julia hljs">function SpeedyWeather.initialize!(forcing::MyForcing,model::SpeedyWeather.ModelSetup)
    # how to initialize it
end</code></pre><p>And similar for <code>SpeedyWeather.forcing!</code>.</p><p>You also probably want to make use of functions that are already defined inside SpeedyWeather or its submodules <code>SpeedyTransforms</code>, or <code>RingGrids</code>. If something does not seem to be defined, although you can see it in the documentation or directly in the code, you probably need to specify its module too! Alternatively, note that you can also always do <code>import SpeedWeather: ModelSetup</code> to bring a given variable into global scope which removes the necessity to write <code>SpeedyWeather.ModelSetup</code>.</p><h2 id="Custom-forcing:-define"><a class="docs-heading-anchor" href="#Custom-forcing:-define">Custom forcing: define</a><a id="Custom-forcing:-define-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-forcing:-define" title="Permalink"></a></h2><p>The following example is a bit more concrete than the previous conceptual example, but we try to add a few more details that are important, or you at least should be aware of it. In this example we want to add a <code>StochasticStirring</code> forcing as defined in <a href="https://doi.org/10.1175/1520-0469(2004)061%3C0264:AMASDM%3E2.0.CO;2">Vallis et al., 2004</a></p><p class="math-container">\[\begin{aligned}
\frac{\partial \zeta}{\partial t} &amp;+ \nabla \cdot (\mathbf{u}(\zeta + f)) =
S - r\zeta - \nu\nabla^{4}\zeta \\ 
S_{l,m}^i &amp;= A(1-\exp(-2\tfrac{\Delta t}{\tau}))Q^i_{l,m} + \exp(-\tfrac{dt}{\tau})S_{l,m}^{i-1} \\
\end{aligned}\]</p><p>So there is a term <code>S</code> that is supposed to force the vorticity equation in the [Barotropic vorticity model]. However, this term is also stochastically evolving in time, meaning we have to store the previous time steps, <span>$i-1$</span>, in spectral space, because that&#39;s where the forcing is defined: for degree <span>$l$</span> and order <span>$m$</span> of the spherical harmonics. <span>$A$</span> is a real amplitude. <span>$\Delta t$</span> the time step of the model, <span>$\tau$</span> the decorrelation time scale of the stochastic process. <span>$Q$</span> is for every spherical harmonic a complex random uniform number in <span>$[-1,1]$</span> in both its real and imaginary components.  So we actually define our <code>StochasticStirring</code> forcing as follows and will explain the details in second</p><pre><code class="language-julia hljs">using SpeedyWeather, Dates

Base.@kwdef struct StochasticStirring{NF} &lt;: SpeedyWeather.AbstractForcing{NF}

    # DIMENSIONS from SpectralGrid
    &quot;Spectral resolution as max degree of spherical harmonics&quot;
    trunc::Int

    &quot;Number of latitude rings, used for latitudinal mask&quot;
    nlat::Int


    # OPTIONS
    &quot;Decorrelation time scale τ [days]&quot;
    decorrelation_time::Float64 = 2

    &quot;Stirring strength A [1/s²]&quot;
    strength::Float64 = 1e-11

    &quot;Stirring latitude [˚N]&quot;
    latitude::Float64 = 45

    &quot;Stirring width [˚]&quot;
    width::Float64 = 24


    # TO BE INITIALISED
    &quot;Stochastic stirring term S&quot;
    S::LowerTriangularMatrix{Complex{NF}} = zeros(LowerTriangularMatrix{Complex{NF}},trunc+2,trunc+1)

    &quot;a = A*sqrt(1 - exp(-2dt/τ)), the noise factor times the stirring strength [1/s²]&quot;
    a::Base.RefValue{NF} = Ref(zero(NF))

    &quot;b = exp(-dt/τ), the auto-regressive factor [1]&quot;
    b::Base.RefValue{NF} = Ref(zero(NF))

    &quot;Latitudinal mask, confined to mid-latitude storm track by default [1]&quot;
    lat_mask::Vector{NF} = zeros(NF,nlat)
end</code></pre><p>So, first the scalar parameters, are added as fields of type <code>Float64</code> with some default values as suggested in the <a href="https://doi.org/10.1175/1520-0469(2004)061%3C0264:AMASDM%3E2.0.CO;2">Vallis et al., 2004</a> paper. In order to be able to define the default values, we add the <code>Base.@kwdef</code> macro before the <code>struct</code> definition. Then we need the term <code>S</code> as coefficients of the spherical harmonics, which is a <code>LowerTriangularMatrix</code>, however we want its elements to be of number format <code>NF</code>, which is also the parametric type of <code>StochasticStirring{NF}</code>, this is done because it will allow us to use multiple dispatch not just based on <code>StochasticStirring</code> but also based on the number format. Neat. In order to allocate <code>S</code> with some default though we need to know the size of the matrix, which is given by the spectral resolution <code>trunc</code>. So in order to automatically allocate <code>S</code> based on the right size we add <code>trunc</code> as another field, which does not have a default but will be initialised with the help of a <code>SpectralGrid</code>, as explained later. So once we call <code>StochasticStirring{NF}(trunc=31)</code> then <code>S</code> will automatically have the right size.</p><p>Then we also see in the definition of <code>S</code> that there are prefactors <span>$A(1-\exp(-2\tfrac{\Delta t}{\tau}))$</span> which depend on the forcing&#39;s parameters but also on the time step, which, at the time of the creation of <code>StochasticStirring</code> we might not know about! And definitely do not want to hardcode in. So to illustrate what you can do in this case we define two additional parameters <code>a,b</code> that are just initialized as zero, but that will be precalculated in the <code>initialize!</code> function. However, we decided to define our <code>struct</code> as <em>immutable</em> (meaning you cannot change it after creation unless its elements have mutable fields, like the elements in vectors). In order to make it mutable, we could write <code>mutable struct</code> instead, or as outlined here use <code>RefValue</code>s. Another option would be to just recalculate <code>a,b</code> in <code>forcing!</code> on every time step. Depending on exactly what you would like to do, you can choose your way. Anyway, we decide to include <code>a,b</code> as <code>RefValue</code>s so that we can always access the scalar  underneath with <code>a[]</code> and <code>b[]</code> and also change it with <code>a[] = 1</code> etc.</p><p>Lastly, the <a href="https://doi.org/10.1175/1520-0469(2004)061%3C0264:AMASDM%3E2.0.CO;2">Vallis et al., 2004</a> paper also describes how the forcing is not supposed to be applied everywhere on the globe but only over a range of latitudes, meaning we want to scale down certain latitudes with a factor approaching zero. For this we want to define a latitudinal mask <code>lat_mask</code> that is a vector of length <code>nlat</code>, the number of latitude rings. Similar to <code>S</code>, we want to allocate it with zeros (or any other value for that matter), but then precompute this mask in the <code>initialize!</code> step. For this we need to know <code>nlat</code> at creation time meaning we add this field similar as to how we added <code>trunc</code>. This mask requires the parameters <code>latitude</code> and a <code>width</code> which are therefore also added to the definition of <code>StochasticStirring</code>.</p><h2 id="Custom-forcing:-generator-function"><a class="docs-heading-anchor" href="#Custom-forcing:-generator-function">Custom forcing: generator function</a><a id="Custom-forcing:-generator-function-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-forcing:-generator-function" title="Permalink"></a></h2><p>Cool. Now you could create our new <code>StochasticStirring</code> forcing with <code>StochasticStirring{NF}(trunc=31,nlat=48)</code>, and the default values would be chosen as well as the correct size of the arrays <code>S</code> and <code>lat_mask</code> we need. Furthermore, note that because <code>StochasticStirring{NF}</code> is parametric on the number format <code>NF</code>, these arrays are also allocated with the correct number format that will be used throughout model integration.</p><p>But in SpeedyWeather we typically use the <a href="../how_to_run_speedy/#SpectralGrid">SpectralGrid</a> object to pass on the information of the resolution (and number format) so we want a generator function like</p><pre><code class="language-julia hljs">function StochasticStirring(SG::SpectralGrid;kwargs...)
    (;trunc,Grid,nlat_half) = SG
    nlat = RingGrids.get_nlat(Grid,nlat_half)
    return StochasticStirring{SG.NF}(;trunc,nlat,kwargs...)
end</code></pre><p>Which allows us to do</p><pre><code class="language-julia hljs">julia&gt; spectral_grid = SpectralGrid(trunc=42,nlev=1)
julia&gt; stochastic_stirring = StochasticStirring(spectral_grid,latitude=30,decorrelation_time=5)</code></pre><p>So the respective resolution parameters and the number format are just pulled from the <code>SpectralGrid</code> as a first argument and the remaining parameters are just keyword arguments that one can change at creation. This evolved as a SpeedyWeather convention: The first argument of the generating function to a model component is a <a href="../how_to_run_speedy/#SpectralGrid">SpectralGrid</a> and other keyword arguments specific to that component follow.</p><h2 id="Custom-forcing:-initialize"><a class="docs-heading-anchor" href="#Custom-forcing:-initialize">Custom forcing: initialize</a><a id="Custom-forcing:-initialize-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-forcing:-initialize" title="Permalink"></a></h2><p>Now let us have a closer look at the details of the <code>initialize!</code> function, in our example we would actually do</p><pre><code class="language-julia hljs">function SpeedyWeather.initialize!( forcing::StochasticStirring,
                                    model::SpeedyWeather.ModelSetup)

    # precompute forcing strength, scale with radius^2 as is the vorticity equation
    (;radius) = model.spectral_grid
    A = radius^2 * forcing.strength

    # precompute noise and auto-regressive factor, packed in RefValue for mutability
    dt = model.time_stepping.Δt_sec
    τ = forcing.decorrelation_time*24*3600   # convert to seconds
    forcing.a[] = A*sqrt(1 - exp(-2dt/τ))
    forcing.b[] = exp(-dt/τ)

    # precompute the latitudinal mask
    (;Grid,nlat_half) = model.spectral_grid
    latd = RingGrids.get_latd(Grid,nlat_half)

    for j in eachindex(forcing.lat_mask)
        # Gaussian centred at forcing.latitude of width forcing.width
        forcing.lat_mask[j] = exp(-(forcing.latitude-latd[j])^2/forcing.width^2*2)
    end

    return nothing
end</code></pre><p>As we want to add a method for the <code>StochasticStirring</code> to the <code>initialize!</code> function from within <code>SpeedyWeather</code> we add the <code>SpeedyWeather.</code> to add this method in the right <a href="#Scope-of-variables">Scope of variables</a>. The <code>initialize!</code> function <em>must</em> have that function signature, instance of your new type <code>StochasticStirring</code> first, then the second argument a <code>model</code> of type <code>ModelSetup</code> or, if your forcing (and in general component) <em>only makes sense</em> in a specific model, you could also write <code>model::Barotropic</code> for example, to be more restrictive. Inside the <code>initialize!</code> method we are defining we can use parameters from other components. For example, the definition of the <code>S</code> term includes the time step <span>$\Delta t$</span>, which should be pulled from the <code>model.time_stepping</code>. We also pull the <code>Grid</code> and its resolution parameter <code>nlat_half</code> (see <a href="../grids/#Grids">Grids</a>) to get the latitudes with <code>get_latd</code> from the <code>RingGrids</code> module. Alternatively, we could have used <code>model.geometry.latd</code> which is contains a bunch of similar arrays describing the geometry of the grid we use and at its given resolution.</p><p>Note that <code>initialize!</code> is expected to be read and write on the <code>forcing</code> argument (hence using Julia&#39;s <code>!</code>-notation) but read-only on the <code>model</code>, except for <code>model.forcing</code> which points to the same object. You technically can initialize or generally alter several model components in one, but that not advised and can easily lead to unexpected behaviour because of multiple dispatch.</p><p>As a last note on <code>initialize!</code>, you can see that we scale the amplitude/strength <code>A</code> with the radius squared, this is because the <a href="../barotropic/#Barotropic-vorticity-equation">Barotropic vorticity equation</a> are scaled that way, so we have to scale <code>S</code> too.</p><h2 id="Custom-forcing:-forcing!-function"><a class="docs-heading-anchor" href="#Custom-forcing:-forcing!-function">Custom forcing: forcing! function</a><a id="Custom-forcing:-forcing!-function-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-forcing:-forcing!-function" title="Permalink"></a></h2><p>Now that we have defined how to create and initialize our new <code>StochasticStirring</code> forcing, we need to define what it actually is supposed <em>to do</em>. For this SpeedyWeather will call the <code>forcing!</code> function within a time step. However, this function is not yet defined for our new <code>StochasticStirring</code> forcing. But if you define it as follows then this will be called automatically with multiple dispatch.</p><pre><code class="language-julia hljs">function SpeedyWeather.forcing!(diagn::SpeedyWeather.DiagnosticVariablesLayer,
                                progn::SpeedyWeather.PrognosticVariablesLayer,
                                forcing::StochasticStirring,
                                time::DateTime,
                                model::SpeedyWeather.ModelSetup)
    # function barrier only
    forcing!(diagn,forcing,model.spectral_transform)
end</code></pre><p>The function has to be as outlined above. The first argument has to be of type <span>$DiagnosticVariablesLayer$</span> as it acts on a layer of the diagnostic variables, where the current model state in grid-point space and the tendencies (in spectral space) are defined. The second argument has to be a <code>PrognosticVariablesLayer</code> because, in general, the forcing may use the prognostic variables in spectral space. The third argument has to be of the type of our new forcing, the third argument is time which you may use or skip, the last element is a <code>ModelSetup</code>, but as before you can be more restrictive to define a forcing only for the <code>BarotropicModel</code> for example, use <span>$model::Barotropic$</span> in that case.</p><p>As you can see, for now not much is actually happening inside this function, this is what is often called a function barrier, the only thing we do in here is to unpack the model to the specific model components we actually need. You can omit this function barrier and jump straight to the definition below, but often this is done for performance reasons: <code>model</code> has several abstract fields which the compiler cannot optimize for, but unpacking them makes that possible. So we define the actual <code>forcing!</code> function that&#39;s then called as follows</p><pre><code class="language-julia hljs">function forcing!(  diagn::SpeedyWeather.DiagnosticVariablesLayer,
                    forcing::StochasticStirring{NF},
                    spectral_transform::SpectralTransform) where NF

    # noise and auto-regressive factors
    a = forcing.a[]    # = sqrt(1 - exp(-2dt/τ))
    b = forcing.b[]    # = exp(-dt/τ)

    (;S) = forcing
    for lm in eachindex(S)
        # Barnes and Hartmann, 2011 Eq. 2
        Qi = 2rand(Complex{NF}) - (1 + im)   # ~ [-1,1] in complex
        S[lm] = a*Qi + b*S[lm]
    end

    # to grid-point space
    S_grid = diagn.dynamics_variables.a_grid
    SpeedyTransforms.gridded!(S_grid,S,spectral_transform)

    # mask everything but mid-latitudes
    RingGrids._scale_lat!(S_grid,forcing.lat_mask)

    # back to spectral space
    (;vor_tend) = diagn.tendencies
    SpeedyTransforms.spectral!(vor_tend,S_grid,spectral_transform)
    SpeedyTransforms.spectral_truncation!(vor_tend)    # set lmax+1 to zero

    return nothing
end</code></pre><p>The function signature can then just match to whatever we need. In our case we have a forcing defined in spectral space which, however, is masked in grid-point space. So we will need the <code>model.spectral_transform</code>. You could recompute the <code>spectral_transform</code> object inside the function but that is inefficient.</p><p>Now this is actually where we implement the equation we started from in <a href="#Custom-forcing:-define">Custom forcing: define</a> simply by looping over the spherical harmonics in <code>S</code> and updating its entries. Then we transform <code>S</code> into grid-point space using the <code>a_grid</code> work array that is in <code>dynamics_variables</code>, <code>b_grid</code> is another one you can use, so are <code>a,b</code> in spectral space. However, these are really work arrays, meaning you should expect them to be overwritten momentarily once the function concludes and no information will remain. Equivalently, these arrays may have an undefined state  prior to the <code>forcing!</code> call. We then use the <code>_scale_lat!</code> function from <code>RingGrids</code> which takes every element in the latitude mask <code>lat_mask</code> and multiplies it with every grid-point on the respective latitude ring.</p><p>Now for the last lines we have to know the order in which different terms are written into the tendencies for vorticity, <code>diagn.tendencies.vor_tend</code>. In SpeedyWeather, the <code>forcing!</code> comes first, then the <code>drag!</code> (see <a href="#Custom-drag">Custom drag</a>) then the curl of the vorticity flux (the vorticity advection). This means we can transform <code>S_grid</code> directly back into <code>vor_tend</code> without overwriting other terms which, in fact, will be added to this array afterwards. In general, you can also force the momentum equations in grid-point space by writing into <code>u_tend_grid</code> and <code>v_tend_grid</code>.</p><p>Then one last detail is the call to <code>spectral_truncation!</code>. Despite the triangular spectral truncation in SpeedyWeather, the lower triangular matrices for the spherical harmonics are actually of size <span>$N+1 \times N$</span>, because this additional degree (=row) is needed for vector quantities (see <a href="../speedytransforms/#One-more-degree-for-spectral-fields">One more degree for spectral fields</a>). Here particularly, this means that the last spectral transform will compute the spherical harmonics of this last degree which, however, scalar quantities like vorticity should not make use of. We therefore set this degree to zero with the call to <code>spectral_truncation!</code>, which does exactly that.</p><h2 id="Custom-forcing:-model-construction"><a class="docs-heading-anchor" href="#Custom-forcing:-model-construction">Custom forcing: model construction</a><a id="Custom-forcing:-model-construction-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-forcing:-model-construction" title="Permalink"></a></h2><p>Now that we have defined a new forcing, how to initialize it and what it is supposed to execute on every time step, we explain how to construct a model with this new forcing. We generally follow other [Model setups], start with the <a href="../how_to_run_speedy/#SpectralGrid">SpectralGrid</a>, use that to get a <code>StochasticStirring</code> forcing instance. This calls the generator function from <a href="#Custom-forcing:-generator-function">Custom forcing: generator function</a>. Here we want to stir vorticity not at the default latitude of 45N, but on the southern hemisphere to illustrate how to pass on non-default parameters. We explicitly set the <code>initial_conditions</code> to rest and pass them as well as <code>forcing=stochastic_stirring</code> on to the <code>BarotropicModel</code> constructor. That&#39;s it! This is really the beauty of our modular interface that you can create instances of individual model components and just put them together as you like, and as long as you follow some rules.</p><pre><code class="language-julia hljs">spectral_grid = SpectralGrid(trunc=42,nlev=1)
stochastic_stirring = StochasticStirring(spectral_grid,latitude=-45)
initial_conditions = StartFromRest()
model = BarotropicModel(;spectral_grid,initial_conditions,forcing=stochastic_stirring)
simulation = initialize!(model)
run!(simulation)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">                         <span class="sgr97"><span class="sgr1">Surface relative vorticity</span></span>                          
       <span class="sgr90">┌────────────────────────────────────────────────────────────┐5.0f-5</span>  
    <span class="sgr90">90</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">┌──┐</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#ffd700"><span class="sgr38_5" style="color:#d7d700">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#d7d700"><span class="sgr38_5" style="color:#afd75f">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#87d75f"><span class="sgr38_5" style="color:#87d75f">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#5fd75f"><span class="sgr38_5" style="color:#5fd75f">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#5faf87"><span class="sgr38_5" style="color:#00af87">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#00af87">▄▄</span></span><span class="sgr90">│</span>   
    ˚N <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#005f87">▄▄▄</span><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#005f87"><span class="sgr38_5" style="color:#005f87">▄</span></span><span class="sgr38_5" style="color:#005f87"><span class="sgr48_5" style="background:#008787">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#00af87">▄▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#005f87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄</span></span><span class="sgr48_5" style="background:#005f87"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄▄</span><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄▄▄▄</span></span><span class="sgr48_5" style="background:#005f87"><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#005f87">▄▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5f5f87">▄</span><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄</span><span class="sgr38_5" style="color:#005f87">▄▄</span><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#00af87">▄</span><span class="sgr38_5" style="color:#008787">▄▄▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#5f5f87">▄</span><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#5f5f87">▄</span><span class="sgr38_5" style="color:#008787">▄▄</span><span class="sgr38_5" style="color:#5f5f87">▄</span><span class="sgr38_5" style="color:#008787">▄▄▄▄▄</span><span class="sgr38_5" style="color:#5f5f87">▄</span><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#005f87"><span class="sgr38_5" style="color:#5f5f87">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄</span><span class="sgr38_5" style="color:#00af87">▄▄</span><span class="sgr38_5" style="color:#5f5f87">▄▄</span><span class="sgr38_5" style="color:#005f87">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#008787">▄▄</span><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#00af87">▄</span><span class="sgr38_5" style="color:#5fd75f">▄</span><span class="sgr38_5" style="color:#87d75f">▄</span><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5f5f87">▄</span><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#5f5f87">▄</span><span class="sgr48_5" style="background:#008787">▄▄▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄▄▄</span><span class="sgr38_5" style="color:#00af87">▄▄</span><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#5f5f87">▄</span><span class="sgr38_5" style="color:#008787">▄▄</span><span class="sgr38_5" style="color:#5f5f87">▄</span><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#afd75f">▄</span><span class="sgr38_5" style="color:#5fd75f">▄</span><span class="sgr38_5" style="color:#005f87">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#5faf87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#008787">▄▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5f5f87">▄</span><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#5f5f87">▄▄</span><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#5f5f87">▄</span><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5fd75f">▄</span><span class="sgr38_5" style="color:#00af87">▄</span><span class="sgr38_5" style="color:#5f5f87">▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#00af87">▄</span></span><span class="sgr38_5" style="color:#00af87"><span class="sgr48_5" style="background:#5fd75f">▄</span><span class="sgr48_5" style="background:#5faf5f">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#5f5f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#00af87">▄</span></span><span class="sgr48_5" style="background:#5f0087"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#008787">▄▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#008787">▄▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄</span></span><span class="sgr48_5" style="background:#5fd75f"><span class="sgr38_5" style="color:#5faf5f">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#5faf87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5fd75f">▄</span></span><span class="sgr38_5" style="color:#5fd75f"><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#008787">▄</span><span class="sgr48_5" style="background:#00af87">▄▄▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#5f5f87">▄▄▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#00af87">▄</span></span><span class="sgr48_5" style="background:#afd700"><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#005f87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#5f5f87">▄▄▄</span><span class="sgr48_5" style="background:#008787">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#5fd75f">▄</span></span><span class="sgr38_5" style="color:#5fd75f"><span class="sgr48_5" style="background:#008787">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#00af87">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#5faf87">▄</span><span class="sgr48_5" style="background:#5faf5f">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#00af87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#00af87">▄</span></span><span class="sgr48_5" style="background:#5fd75f"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr48_5" style="background:#5faf87"><span class="sgr38_5" style="color:#00af87">▄</span></span><span class="sgr38_5" style="color:#00af87"><span class="sgr48_5" style="background:#008787">▄</span><span class="sgr48_5" style="background:#5f5f87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5faf5f">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#5faf87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄▄▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#005f87"><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#00af87">▄</span></span><span class="sgr38_5" style="color:#00af87"><span class="sgr48_5" style="background:#00af87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#005f87">▄</span></span><span class="sgr38_5" style="color:#005f87"><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄</span><span class="sgr38_5" style="color:#5f5f87">▄▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#00af87">▄</span></span><span class="sgr38_5" style="color:#00af87"><span class="sgr48_5" style="background:#008787">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#00af87">▄</span><span class="sgr48_5" style="background:#5faf5f">▄</span><span class="sgr48_5" style="background:#5faf87">▄</span><span class="sgr48_5" style="background:#008787">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#005f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄▄▄▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#00af87">▄</span><span class="sgr48_5" style="background:#5faf87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#5f5f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#005f87">▄</span><span class="sgr38_5" style="color:#008787">▄▄</span><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#5f0087">▄</span></span><span class="sgr48_5" style="background:#5f005f"><span class="sgr38_5" style="color:#5f005f">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr48_5" style="background:#5fd75f"><span class="sgr38_5" style="color:#008787">▄</span><span class="sgr38_5" style="color:#00af87">▄</span></span><span class="sgr48_5" style="background:#00af87"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#008787">▄▄▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#005f87">▄▄</span><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#008787">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#5f5f87">▄▄▄▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#008787">▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#5f0087"><span class="sgr38_5" style="color:#5f005f">▄▄</span></span><span class="sgr90">│</span>   
       <span class="sgr90">│</span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#005f87">▄</span><span class="sgr48_5" style="background:#008787">▄▄▄</span><span class="sgr48_5" style="background:#00af87">▄▄</span><span class="sgr48_5" style="background:#008787">▄▄▄▄▄</span><span class="sgr48_5" style="background:#005f87">▄</span><span class="sgr48_5" style="background:#5f5f87">▄▄▄▄▄</span><span class="sgr48_5" style="background:#008787">▄▄▄▄</span><span class="sgr48_5" style="background:#5f5f87">▄▄</span><span class="sgr48_5" style="background:#005f87">▄</span><span class="sgr48_5" style="background:#008787">▄</span></span><span class="sgr48_5" style="background:#005f87"><span class="sgr38_5" style="color:#5f5f87">▄</span></span><span class="sgr38_5" style="color:#5f5f87"><span class="sgr48_5" style="background:#5f5f87">▄▄▄</span></span><span class="sgr48_5" style="background:#005f87"><span class="sgr38_5" style="color:#005f87">▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#005f87">▄</span><span class="sgr48_5" style="background:#5f5f87">▄▄▄▄</span><span class="sgr48_5" style="background:#005f87">▄</span><span class="sgr48_5" style="background:#008787">▄▄▄▄▄</span></span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#005f87">▄▄▄▄▄</span></span><span class="sgr38_5" style="color:#005f87"><span class="sgr48_5" style="background:#005f87">▄</span></span><span class="sgr48_5" style="background:#5f5f87"><span class="sgr38_5" style="color:#008787">▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#005f87">▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#5f005f"><span class="sgr38_5" style="color:#5f005f">▄▄</span></span><span class="sgr90">│</span>   
   <span class="sgr90">-90</span> <span class="sgr90">│</span><span class="sgr48_5" style="background:#008787"><span class="sgr38_5" style="color:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr38_5" style="color:#008787"><span class="sgr48_5" style="background:#00af87">▄▄▄</span><span class="sgr48_5" style="background:#008787">▄▄▄▄▄▄▄▄</span><span class="sgr48_5" style="background:#005f87">▄▄</span><span class="sgr48_5" style="background:#008787">▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄▄</span></span><span class="sgr90">│</span> <span class="sgr90">└──┘</span>   
       <span class="sgr90">└────────────────────────────────────────────────────────────┘-4.0f-5</span> 
        <span class="sgr90">0</span>                           ˚E                           <span class="sgr90">360</span>         </code></pre><p>Yay! As you can see the vorticity does something funky on the southern hemisphere but not on the northern, as we do not force there. Awesome! Adding new components other than forcing works surprisingly similar. We briefly discuss how to add a custom drag to illustrate the differences but there are not really many.</p><h2 id="Custom-drag"><a class="docs-heading-anchor" href="#Custom-drag">Custom drag</a><a id="Custom-drag-1"></a><a class="docs-heading-anchor-permalink" href="#Custom-drag" title="Permalink"></a></h2><p>From the barotropic vorticity equation in <a href="#Custom-forcing:-define">Custom forcing: define</a> we omitted the drag term <span>$-r\zeta$</span> which however can be defined in a strikingly similar way. This section is just to outline some differences.</p><p>SpeedyWeather defines <code>AbstractForcing</code> and <code>AbstractDrag</code>, both are only conceptual supertypes, and in fact you could define a forcing as a subtype of <code>AbstractDrag</code> and vice versa. So for a drag, most straight-forwardly you would do</p><pre><code class="language-julia hljs">struct MyDrag &lt;: AbstractDrag
    # parameters and arrays
end</code></pre><p>then define the <code>initialize!</code> function as before, but extend the method <code>drag!</code> instead of <code>forcing!</code>. The only detail that is important to know is that <code>forcing!</code> is called first, then <code>drag!</code> and then the other tendencies. So if you write into <code>vor_tend</code> like so <code>vor_tend[1] = 1</code>, you will overwrite the previous tendency. For the forcing that does not matter as it is the first one to be called, but for the drag you will want to do <code>vor_tend[1] += 1</code> instead to accumulate the tendency. Otherwise you would undo the forcing term! Note that this conflict would be avoided if the forcing writes into <code>vor_tend</code> but the drag writes into <code>u_tend_grid</code>.</p><p>In general, these are the fields you can write into for new terms</p><ul><li><code>vor_tend</code> in spectral space</li><li><code>div_tend</code> in spectral space (shallow water only)</li><li><code>pres_tend</code> in spectral space (shallow water only)</li><li><code>u_tend_grid</code> in grid-point space</li><li><code>v_tend_grid</code> in grid-point space</li></ul><p>These space restrictions exist because of the way how SpeedyWeather transforms between spaces to obtain tendencies.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../parameterizations/">« Parameterizations</a><a class="docs-footer-nextpage" href="../output/">NetCDF output »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.2.1 on <span class="colophon-date" title="Wednesday 24 January 2024 21:18">Wednesday 24 January 2024</span>. Using Julia version 1.10.0.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
